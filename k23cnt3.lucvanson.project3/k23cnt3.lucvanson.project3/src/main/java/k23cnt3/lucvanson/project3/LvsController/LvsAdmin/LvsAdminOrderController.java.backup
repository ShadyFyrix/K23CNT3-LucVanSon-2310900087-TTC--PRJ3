package k23cnt3.lucvanson.project3.LvsController.LvsAdmin;

import k23cnt3.lucvanson.project3.LvsEntity.*;
import k23cnt3.lucvanson.project3.LvsService.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import jakarta.servlet.http.HttpSession;

import java.util.List;
import java.util.ArrayList;
import java.util.Map;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

/**
 * Controller quáº£n lÃ½ ÄÆ¡n hÃ ng (Order) trong Admin Panel
 * 
 * <p>
 * Chá»©c nÄƒng chÃ­nh:
 * </p>
 * <ul>
 * <li>Hiá»ƒn thá»‹ danh sÃ¡ch Ä‘Æ¡n hÃ ng vá»›i phÃ¢n trang, tÃ¬m kiáº¿m vÃ 
 * lá»c</li>
 * <li>Xem chi tiáº¿t Ä‘Æ¡n hÃ ng vÃ  items</li>
 * <li>Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng</li>
 * <li>Há»§y Ä‘Æ¡n hÃ ng</li>
 * <li>HoÃ n tiá»n</li>
 * <li>Xuáº¥t hÃ³a Ä‘Æ¡n</li>
 * </ul>
 * 
 * <p>
 * Template paths:
 * </p>
 * <ul>
 * <li>List: LvsAreas/LvsAdmin/LvsOrder/LvsList.html</li>
 * <li>Detail: LvsAreas/LvsAdmin/LvsOrder/LvsDetail.html</li>
 * </ul>
 * 
 * @author LucVanSon
 * @version 1.0
 * @since 2024
 */
@Controller
@RequestMapping("/LvsAdmin/LvsOrder")
@PreAuthorize("hasAuthority('ROLE_ADMIN')")
public class LvsAdminOrderController {

    @Autowired
    private LvsOrderService lvsOrderService;

    @Autowired
    private LvsUserService lvsUserService;

    @Autowired
    private LvsProjectService lvsProjectService;

    /**
     * Hiá»ƒn thá»‹ danh sÃ¡ch Ä‘Æ¡n hÃ ng
     */
    @GetMapping("/LvsList")
    public String lvsListOrders(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "30") int size,
            @RequestParam(required = false) String lvsStatus,
            @RequestParam(required = false) String lvsKeyword,
            Model model) {
        Pageable lvsPageable = PageRequest.of(page, size);
        Page<LvsOrder> lvsOrders;

        if (lvsKeyword != null && !lvsKeyword.isEmpty()) {
            lvsOrders = lvsOrderService.lvsSearchOrders(lvsKeyword, lvsPageable);
        } else if (lvsStatus != null && !lvsStatus.isEmpty()) {
            lvsOrders = lvsOrderService.lvsGetOrdersByStatus(lvsStatus, lvsPageable);
        } else {
            lvsOrders = lvsOrderService.lvsGetAllOrders(lvsPageable);
        }

        model.addAttribute("LvsOrders", lvsOrders);
        model.addAttribute("LvsStatuses", LvsOrder.LvsOrderStatus.values());
        model.addAttribute("LvsSelectedStatus", lvsStatus);
        model.addAttribute("LvsKeyword", lvsKeyword);
        model.addAttribute("LvsCurrentPage", page);

        return "LvsAreas/LvsAdmin/LvsOrder/LvsList";
    }

    /**
     * Hiển thị form tạo đơn hàng mới
     */
    @GetMapping("/LvsCreate")
    public String lvsShowCreateForm(Model model) {
        // Lấy danh sách users - pass Page object
        Pageable lvsUserPageable = PageRequest.of(0, 1000);
        Page<LvsUser> lvsUsers = lvsUserService.lvsGetAllUsers(lvsUserPageable);

        // Lấy danh sách projects - pass Page object
        Pageable lvsProjectPageable = PageRequest.of(0, 1000);
        Page<LvsProject> lvsProjects = lvsProjectService.lvsGetAllProjects(lvsProjectPageable);

        // Pass Page objects directly, template will use .content
        model.addAttribute("lvsUsers", lvsUsers);
        model.addAttribute("lvsProjects", lvsProjects);

        return "LvsAreas/LvsAdmin/LvsOrder/LvsCreate";
    }

    /**
     * Debug endpoint to check data
     */
    @GetMapping("/LvsDebug")
    public String lvsDebugCreateForm(Model model) {
        // Same data loading as create form
        Pageable lvsUserPageable = PageRequest.of(0, 1000);
        Page<LvsUser> lvsUserPage = lvsUserService.lvsGetAllUsers(lvsUserPageable);

        Pageable lvsProjectPageable = PageRequest.of(0, 1000);
        Page<LvsProject> lvsProjectPage = lvsProjectService.lvsGetAllProjects(lvsProjectPageable);

        model.addAttribute("lvsUsers", lvsUserPage.getContent());
        model.addAttribute("lvsProjects", lvsProjectPage.getContent());

        return "LvsAreas/LvsAdmin/LvsOrder/LvsDebug";
    }

    /**
     * Xử lý tạo đơn hàng mới
     */
    // @PostMapping("/LvsCreateOld") - DISABLED
    public String lvsCreateOrder(
            @RequestParam Long lvsBuyerId,
            @RequestParam(required = false) String lvsNotes,
            @RequestParam String lvsStatus,
            @RequestParam String lvsOrderItemsJson,
            Model model) {
        try {
            // Parse order items from JSON
            com.fasterxml.jackson.databind.ObjectMapper mapper = new com.fasterxml.jackson.databind.ObjectMapper();
            java.util.List<java.util.Map<String, Object>> items = mapper.readValue(
                    lvsOrderItemsJson,
                    new com.fasterxml.jackson.core.type.TypeReference<java.util.List<java.util.Map<String, Object>>>() {
                    });

            if (items.isEmpty()) {
                model.addAttribute("LvsError", "Vui lòng thêm ít nhất một sản phẩm!");
                return lvsShowCreateForm(model);
            }

    /**
     * Xử lý tạo đơn hàng mới (simplified version)
     */
    @PostMapping("/LvsCreate")
    public String lvsCreateOrderSimple(
            @RequestParam Long lvsBuyerId,
            @RequestParam Long lvsProjectId,
            @RequestParam Integer lvsQuantity,
            @RequestParam(required = false) String lvsNotes,
            @RequestParam String lvsStatus,
            RedirectAttributes redirectAttributes,
            Model model) {
        try {
            // Validate inputs
            if (lvsQuantity == null || lvsQuantity < 1) {
                model.addAttribute("LvsError", "Số lượng phải lớn hơn 0!");
                return lvsShowCreateForm(model);
            }

            // Get buyer
            LvsUser lvsBuyer = lvsUserService.lvsGetUserById(lvsBuyerId);
            if (lvsBuyer == null) {
                model.addAttribute("LvsError", "Không tìm thấy khách hàng!");
                return lvsShowCreateForm(model);
            }

            // Get project
            LvsProject lvsProject = lvsProjectService.lvsGetProjectById(lvsProjectId);
            if (lvsProject == null) {
                model.addAttribute("LvsError", "Không tìm thấy sản phẩm!");
                return lvsShowCreateForm(model);
            }

            // Calculate total
            double lvsTotal = lvsProject.getLvsPrice() * lvsQuantity;

            // Check balance if status is COMPLETED
            LvsOrder.LvsOrderStatus orderStatus = LvsOrder.LvsOrderStatus.valueOf(lvsStatus);
            if (orderStatus == LvsOrder.LvsOrderStatus.COMPLETED) {
                Double currentBalance = lvsBuyer.getLvsBalance();
                if (currentBalance == null) currentBalance = 0.0;
                
                if (currentBalance < lvsTotal) {
                    model.addAttribute("LvsError", 
                        "Khách hàng không đủ coin! Cần: " + lvsTotal + " coins, Có: " + currentBalance + " coins");
                    return lvsShowCreateForm(model);
                }
            }

            // Create order
            LvsOrder lvsOrder = new LvsOrder();
            lvsOrder.setLvsBuyer(lvsBuyer);
            lvsOrder.setLvsNotes(lvsNotes);
            lvsOrder.setLvsStatus(orderStatus);
            lvsOrder.setLvsOrderCode("ORD-" + System.currentTimeMillis());
            lvsOrder.setLvsTotalAmount(lvsTotal);
            lvsOrder.setLvsFinalAmount(lvsTotal);

            // Create order item
            LvsOrderItem lvsOrderItem = new LvsOrderItem();
            lvsOrderItem.setLvsOrder(lvsOrder);
            lvsOrderItem.setLvsProject(lvsProject);
            lvsOrderItem.setLvsQuantity(lvsQuantity);
            lvsOrderItem.setLvsUnitPrice(lvsProject.getLvsPrice());
            lvsOrderItem.setLvsItemTotal(lvsTotal);

            java.util.List<LvsOrderItem> lvsOrderItems = new java.util.ArrayList<>();
            lvsOrderItems.add(lvsOrderItem);
            lvsOrder.setLvsOrderItems(lvsOrderItems);

            // Save order
            LvsOrder lvsSavedOrder = lvsOrderService.lvsSaveOrder(lvsOrder);

            // Deduct coins if status is COMPLETED
            if (orderStatus == LvsOrder.LvsOrderStatus.COMPLETED) {
                Double currentBalance = lvsBuyer.getLvsBalance();
                lvsBuyer.setLvsBalance(currentBalance - lvsTotal);
                lvsUserService.lvsUpdateUser(lvsBuyer);
            }

            redirectAttributes.addFlashAttribute("LvsSuccess", 
                "Tạo đơn hàng thành công! Mã đơn: " + lvsSavedOrder.getLvsOrderCode());
            return "redirect:/LvsAdmin/LvsOrder/LvsDetail/" + lvsSavedOrder.getLvsOrderId();

        } catch (Exception e) {
            e.printStackTrace();
            model.addAttribute("LvsError", "Lỗi: " + e.getMessage());
            return lvsShowCreateForm(model);
        }
    }


            // Get buyer
            LvsUser lvsBuyer = lvsUserService.lvsGetUserById(lvsBuyerId);
            if (lvsBuyer == null) {
                model.addAttribute("LvsError", "Không tìm thấy khách hàng!");
                return lvsShowCreateForm(model);
            }

            // Create order
            LvsOrder lvsOrder = new LvsOrder();
            lvsOrder.setLvsBuyer(lvsBuyer);
            lvsOrder.setLvsNotes(lvsNotes);
            lvsOrder.setLvsStatus(LvsOrder.LvsOrderStatus.valueOf(lvsStatus));
            lvsOrder.setLvsOrderCode("ORD-" + System.currentTimeMillis());

            // Calculate total
            double lvsTotal = 0;
            java.util.List<LvsOrderItem> lvsOrderItems = new java.util.ArrayList<>();

            for (java.util.Map<String, Object> item : items) {
                Long lvsProjectId = Long.valueOf(item.get("projectId").toString());
                int lvsQuantity = Integer.parseInt(item.get("quantity").toString());

                LvsProject lvsProject = lvsProjectService.lvsGetProjectById(lvsProjectId);
                if (lvsProject != null) {
                    LvsOrderItem lvsOrderItem = new LvsOrderItem();
                    lvsOrderItem.setLvsOrder(lvsOrder);
                    lvsOrderItem.setLvsProject(lvsProject);
                    lvsOrderItem.setLvsQuantity(lvsQuantity);
                    lvsOrderItem.setLvsUnitPrice(lvsProject.getLvsPrice());

                    lvsOrderItems.add(lvsOrderItem);
                    lvsTotal += lvsProject.getLvsPrice() * lvsQuantity;
                }
            }

            lvsOrder.setLvsOrderItems(lvsOrderItems);
            lvsOrder.setLvsFinalAmount(lvsTotal);

            // Save order
            LvsOrder lvsSavedOrder = lvsOrderService.lvsSaveOrder(lvsOrder);

            // Deduct coins if status is COMPLETED
            if (lvsSavedOrder.getLvsStatus() == LvsOrder.LvsOrderStatus.COMPLETED) {
                Double currentBalance = lvsBuyer.getLvsBalance();
                if (currentBalance == null)
                    currentBalance = 0.0;

                if (currentBalance >= lvsTotal) {
                    // Deduct coins from buyer
                    lvsBuyer.setLvsBalance(currentBalance - lvsTotal);
                    lvsUserService.lvsUpdateUser(lvsBuyer);
                } else {
                    // Insufficient funds - delete order and return error
                    lvsOrderService.lvsDeleteOrder(lvsSavedOrder.getLvsOrderId());
                    model.addAttribute("LvsError",
                            "Khách hàng không đủ coin! Cần: " + lvsTotal + " coins, Có: " + currentBalance + " coins");
                    return lvsShowCreateForm(model);
                }
            }

            return "redirect:/LvsAdmin/LvsOrder/LvsDetail/" + lvsSavedOrder.getLvsOrderId();

        } catch (Exception e) {
            model.addAttribute("LvsError", "Lỗi: " + e.getMessage());
            return lvsShowCreateForm(model);
        }
    }

    /**
     * Hiển thị form chỉnh sửa đơn hàng
     */
    @GetMapping("/LvsEdit/{id}")
    public String lvsShowEditForm(@PathVariable Long id, Model model) {
        LvsOrder lvsOrder = lvsOrderService.lvsGetOrderById(id);

        if (lvsOrder == null) {
            return "redirect:/LvsAdmin/LvsOrder/LvsList";
        }

        model.addAttribute("LvsOrder", lvsOrder);
        return "LvsAreas/LvsAdmin/LvsOrder/LvsEdit";
    }

    /**
     * Xem chi tiáº¿t Ä‘Æ¡n hÃ ng
     */
    @GetMapping("/LvsDetail/{id}")
    public String lvsViewOrderDetail(@PathVariable Long id,
            Model model) {
        LvsOrder lvsOrder = lvsOrderService.lvsGetOrderById(id);

        if (lvsOrder == null) {
            return "redirect:/LvsAdmin/LvsOrder/LvsList";
        }

        List<LvsOrderItem> lvsOrderItems = lvsOrder.getLvsOrderItems();

        model.addAttribute("LvsOrder", lvsOrder);
        model.addAttribute("LvsOrderItems", lvsOrderItems);

        return "LvsAreas/LvsAdmin/LvsOrder/LvsDetail";
    }

    /**
     * Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng
     */
    @PostMapping("/LvsUpdateStatus/{id}")
    public String lvsUpdateOrderStatus(@PathVariable Long id,
            @RequestParam LvsOrder.LvsOrderStatus lvsStatus,
            @RequestParam(required = false) String lvsNotes,
            Model model) {
        try {
            lvsOrderService.lvsUpdateOrderStatus(id, lvsStatus, lvsNotes);
            model.addAttribute("LvsSuccess", "ÄÃ£ cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng!");
        } catch (Exception e) {
            model.addAttribute("LvsError", "Lá»—i: " + e.getMessage());
        }

        return "redirect:/LvsAdmin/LvsOrder/LvsDetail/" + id;
    }

    /**
     * Há»§y Ä‘Æ¡n hÃ ng
     */
    @PostMapping("/LvsCancel/{id}")
    public String lvsCancelOrder(@PathVariable Long id,
            @RequestParam String lvsReason,
            Model model) {
        try {
            lvsOrderService.lvsCancelOrderByAdmin(id, lvsReason);
            model.addAttribute("LvsSuccess", "ÄÃ£ há»§y Ä‘Æ¡n hÃ ng!");
        } catch (Exception e) {
            model.addAttribute("LvsError", "Lá»—i: " + e.getMessage());
        }

        return "redirect:/LvsAdmin/LvsOrder/LvsDetail/" + id;
    }

    /**
     * HoÃ n tiá»n Ä‘Æ¡n hÃ ng
     */
    @PostMapping("/LvsRefund/{id}")
    public String lvsRefundOrder(@PathVariable Long id,
            @RequestParam Double lvsAmount,
            @RequestParam String lvsReason,
            HttpSession session,
            Model model) {
        try {
            LvsUser lvsAdmin = (LvsUser) session.getAttribute("LvsCurrentUser");
            lvsOrderService.lvsRefundOrder(id, lvsAmount, lvsReason, lvsAdmin.getLvsUserId());

            model.addAttribute("LvsSuccess", "ÄÃ£ hoÃ n tiá»n Ä‘Æ¡n hÃ ng!");
        } catch (Exception e) {
            model.addAttribute("LvsError", "Lá»—i: " + e.getMessage());
        }

        return "redirect:/LvsAdmin/LvsOrder/LvsDetail/" + id;
    }

    /**
     * Xuáº¥t hÃ³a Ä‘Æ¡n
     */
    @GetMapping("/LvsInvoice/{id}")
    public String lvsGenerateInvoice(@PathVariable Long id,
            Model model) {
        LvsOrder lvsOrder = lvsOrderService.lvsGetOrderById(id);

        if (lvsOrder == null) {
            return "redirect:/LvsAdmin/LvsOrder/LvsList";
        }

        model.addAttribute("LvsOrder", lvsOrder);

        return "LvsAreas/LvsAdmin/LvsOrder/LvsInvoice";
    }

    /**
     * TÃ¬m kiáº¿m Ä‘Æ¡n hÃ ng theo user
     */
    @GetMapping("/LvsSearchByUser")
    public String lvsSearchOrdersByUser(@RequestParam Long lvsUserId,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size,
            Model model) {
        Pageable lvsPageable = PageRequest.of(page, size);
        Page<LvsOrder> lvsOrders = lvsOrderService.lvsGetOrdersByUser(lvsUserId, lvsPageable);

        LvsUser lvsUser = lvsUserService.lvsGetUserById(lvsUserId);

        model.addAttribute("LvsOrders", lvsOrders);
        model.addAttribute("LvsUser", lvsUser);
        model.addAttribute("LvsCurrentPage", page);

        return "LvsAreas/LvsAdmin/LvsOrder/LvsUser";
    }
}



