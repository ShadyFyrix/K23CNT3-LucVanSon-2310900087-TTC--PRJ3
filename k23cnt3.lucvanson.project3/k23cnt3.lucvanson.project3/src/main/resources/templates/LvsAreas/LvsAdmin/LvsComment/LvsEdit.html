<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{LvsAreas/LvsAdmin/LvsLayout/LvsAdmin-layout}" lang="vi">

<head>
    <title>Chỉnh sửa Bình luận</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="dashboard-container" style="max-width: 1000px; margin: 2rem auto; padding: 1rem;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Chỉnh sửa Bình luận</h1>
                <a th:href="@{/LvsAdmin/LvsComment/LvsDetail/{id}(id=${LvsComment.lvsCommentId})}"
                    class="btn btn-outline-secondary"><i class="fas fa-arrow-left"></i> Quay lại</a>
            </div>

            <div class="card">
                <div class="card-body">
                    <form id="editForm" th:action="@{/LvsAdmin/LvsComment/LvsEdit/{id}(id=${LvsComment.lvsCommentId})}"
                        th:object="${LvsComment}" method="post" enctype="multipart/form-data">

                        <!-- Content -->
                        <div class="mb-3">
                            <label class="form-label">Nội dung <span class="text-danger">*</span></label>
                            <textarea class="form-control" th:field="*{lvsContent}" rows="8" required></textarea>
                        </div>

                        <!-- Existing Images - NO NESTED FORMS -->
                        <div class="mb-3" th:if="${LvsComment.lvsImages != null and !LvsComment.lvsImages.isEmpty()}">
                            <label class="form-label"><i class="fas fa-images"></i> Ảnh hiện có</label>
                            <div class="row g-2">
                                <div class="col-md-2 col-sm-3 col-4" th:each="img : ${LvsComment.lvsImages}">
                                    <div class="position-relative">
                                        <img th:src="@{${img.lvsImageUrl}}" class="img-fluid rounded shadow"
                                            style="width:100%;height:100px;object-fit:cover">
                                        <!-- DELETE BUTTON - NOT A FORM -->
                                        <button type="button"
                                            class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1"
                                            th:attr="data-image-id=${img.lvsImageId}" onclick="deleteImage(this)"
                                            title="Xóa ảnh">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <span class="position-absolute bottom-0 start-0 m-1 badge bg-primary"
                                            th:text="${img.lvsImageOrder + 1}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Add New Images -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-plus-circle"></i> Thêm ảnh mới (max 5 ảnh tổng)
                            </label>
                            <input type="file" class="form-control" name="images" id="editNewImgs" accept="image/*"
                                multiple>
                            <small class="text-muted">JPG, PNG, GIF, WEBP. Max 5MB/ảnh</small>
                            <div id="editNewPreview" class="row g-2 mt-2"></div>
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <a th:href="@{/LvsAdmin/LvsComment/LvsDetail/{id}(id=${LvsComment.lvsCommentId})}"
                                class="btn btn-secondary">Hủy</a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Cập nhật
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // CSRF token for delete requests
        const csrfToken = /*[[${_csrf.token}]]*/ '';
        const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

        // Delete image function
        function deleteImage(button) {
            if (!confirm('Xóa ảnh này?')) return;

            const imageId = button.getAttribute('data-image-id');
            const formData = new FormData();
            formData.append('_csrf', csrfToken);

            fetch(`/lvsforum/LvsAdmin/LvsComment/LvsDeleteImage/${imageId}`, {
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                },
                body: formData
            })
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else {
                        window.location.reload();
                    }
                })
                .catch(error => {
                    alert('Lỗi: ' + error);
                });
        }

        // Image preview
        window.addEventListener('DOMContentLoaded', function () {
            const input = document.getElementById('editNewImgs');
            const preview = document.getElementById('editNewPreview');

            if (input && preview) {
                input.addEventListener('change', function (e) {
                    preview.innerHTML = '';
                    const files = Array.from(e.target.files).slice(0, 5);

                    files.forEach((file, index) => {
                        if (file.size > 5 * 1024 * 1024) {
                            alert(file.name + ' quá lớn! Max 5MB');
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function (event) {
                            const div = document.createElement('div');
                            div.className = 'col-2';
                            div.innerHTML = `
                                <div class="position-relative">
                                    <img src="${event.target.result}" 
                                         class="img-fluid rounded shadow" 
                                         style="height:100px;object-fit:cover">
                                    <span class="position-absolute top-0 start-0 m-1 badge bg-success">Mới</span>
                                </div>
                            `;
                            preview.appendChild(div);
                        };
                        reader.readAsDataURL(file);
                    });
                });
            }
        });
    </script>
</body>

</html>