<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{LvsAreas/LvsUsers/LvsLayout/LvsUser-layout}">

<head>
    <title th:text="${project?.lvsProjectName ?: 'Project'} + ' - Electro Store'">Project Detail - Electro Store</title>
</head>

<body>
    <div layout:fragment="content" class="min-h-screen">
        <!-- Success/Error Messages -->
        <div th:if="${param.success}" class="container mx-auto px-4 pt-4">
            <div class="bg-green-500/20 border border-green-500 text-green-400 px-6 py-4 rounded-lg mb-4">
                <i class="fas fa-check-circle mr-2"></i>
                <span th:text="${param.success}">Success message</span>
            </div>
        </div>
        <div th:if="${param.error}" class="container mx-auto px-4 pt-4">
            <div class="bg-red-500/20 border border-red-500 text-red-400 px-6 py-4 rounded-lg mb-4">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span th:text="${param.error}">Error message</span>
            </div>
        </div>

        <!-- Breadcrumb -->
        <div class="bg-[#1e1e1e] border-b border-[#333]">
            <div class="container mx-auto px-4 py-4 flex items-center gap-2 text-sm text-gray-400">
                <a th:href="@{/LvsUser/LvsDashboard}" class="hover:text-[#fed700] transition">
                    <i class="fas fa-home mr-1"></i>Home
                </a>
                <i class="fas fa-chevron-right text-xs"></i>
                <a th:href="@{/LvsUser/LvsProject/LvsList}" class="hover:text-[#fed700] transition">Browse Projects</a>
                <i class="fas fa-chevron-right text-xs"></i>
                <span class="text-white font-medium" th:text="${project?.lvsProjectName ?: 'Project'}">Project
                    Name</span>
            </div>
        </div>

        <section class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Content -->
                <div class="lg:col-span-2">
                    <!-- Project Header -->
                    <div class="bg-[#2b2b2b] rounded-xl border border-[#333] p-8 mb-6">
                        <div class="flex items-start justify-between mb-6">
                            <div>
                                <div class="flex items-center gap-3 mb-3">
                                    <span th:if="${project?.lvsCategory != null}"
                                        class="text-[#fed700] text-xs font-bold px-3 py-1 border border-[#fed700] rounded-full uppercase tracking-wider"
                                        th:text="${project.lvsCategory.lvsCategoryName}">Category</span>
                                    <span
                                        class="text-green-400 text-xs font-bold px-3 py-1 bg-green-500/20 border border-green-500 rounded-full">
                                        <i class="fas fa-check-circle mr-1"></i>VERIFIED
                                    </span>
                                </div>
                                <h1 class="text-4xl font-bold text-white mb-2"
                                    th:text="${project?.lvsProjectName ?: 'Project'}">
                                    Project Name</h1>
                                <p class="text-gray-400">
                                    by <a href="#" class="text-[#fed700] hover:underline"
                                        th:text="${project.lvsUser?.lvsUsername ?: 'Unknown'}">Creator</a>
                                </p>
                            </div>
                        </div>

                        <!-- Project Image Gallery -->
                        <div class="border border-[#333] rounded-lg overflow-hidden bg-[#1e1e1e] mb-6">
                            <!-- Main Image Display -->
                            <div id="mainImageContainer" class="relative">
                                <img id="mainImage" th:if="${project?.lvsThumbnailUrl != null}"
                                    th:src="@{${project.lvsThumbnailUrl}}" class="w-full h-96 object-cover"
                                    alt="Project Image">
                                <div th:unless="${project?.lvsThumbnailUrl != null}"
                                    class="w-full h-96 flex items-center justify-center">
                                    <i class="fas fa-gamepad text-gray-600 text-9xl"></i>
                                </div>

                                <!-- Navigation Arrows (shown when multiple images exist) -->
                                <button id="prevBtn" onclick="changeImage(-1)"
                                    class="hidden absolute left-4 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-3 rounded-full transition">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button id="nextBtn" onclick="changeImage(1)"
                                    class="hidden absolute right-4 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-3 rounded-full transition">
                                    <i class="fas fa-chevron-right"></i>
                                </button>

                                <!-- Image Counter -->
                                <div id="imageCounter"
                                    class="hidden absolute bottom-4 right-4 bg-black/70 text-white px-3 py-1 rounded-full text-sm">
                                    <span id="currentImageNum">1</span> / <span id="totalImages">1</span>
                                </div>
                            </div>

                            <!-- Thumbnail Gallery -->
                            <div id="thumbnailGallery" class="hidden bg-[#1e1e1e] p-4 border-t border-[#333]">
                                <div class="flex gap-2 overflow-x-auto" id="thumbnailContainer">
                                    <!-- Thumbnails will be inserted here by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-[#1e1e1e] border border-[#333] rounded-lg p-4 text-center">
                                <div class="flex text-[#fed700] text-sm justify-center mb-2">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star-half-alt"></i>
                                </div>
                                <p class="text-gray-400 text-xs" th:text="${project?.lvsReviewCount ?: 0} + ' Reviews'">
                                    0
                                    Reviews</p>
                            </div>
                            <div class="bg-[#1e1e1e] border border-[#333] rounded-lg p-4 text-center">
                                <i class="fas fa-download text-[#fed700] text-2xl mb-2"></i>
                                <p class="text-gray-400 text-xs">1.2K Downloads</p>
                            </div>
                            <div class="bg-[#1e1e1e] border border-[#333] rounded-lg p-4 text-center">
                                <i class="fas fa-heart text-[#fed700] text-2xl mb-2"></i>
                                <p class="text-gray-400 text-xs">234 Favorites</p>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="border-t border-[#333] pt-6">
                            <h2 class="text-xl font-bold text-white mb-4">
                                <i class="fas fa-info-circle text-[#fed700] mr-2"></i>About This Project
                            </h2>
                            <p class="text-gray-400 leading-relaxed whitespace-pre-line"
                                th:text="${project?.lvsDescription ?: 'No description available'}">
                                Project description goes here.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Sidebar - Purchase Section -->
                <div class="lg:col-span-1">
                    <div class="bg-[#2b2b2b] border border-[#333] rounded-xl p-6 sticky top-4">
                        <!-- Price -->
                        <div class="text-center mb-6 pb-6 border-b border-[#333]">
                            <div class="text-5xl font-bold text-[#fed700] mb-2"
                                th:text="${project?.lvsPrice != null ? #numbers.formatDecimal(project.lvsPrice, 0, 'COMMA', 0, 'POINT') : '0'}">
                                0</div>
                            <p class="text-gray-400 text-sm">
                                <i class="fas fa-coins text-[#fed700]"></i> Coins
                            </p>
                        </div>

                        <!-- Your Balance -->
                        <div th:if="${session.LvsCurrentUser}"
                            class="bg-[#1e1e1e] border border-[#333] rounded-lg p-4 mb-6">
                            <p class="text-gray-400 text-sm mb-1">Your Balance:</p>
                            <p class="text-white font-bold text-xl">
                                <i class="fas fa-wallet text-[#fed700] mr-2"></i>
                                <span
                                    th:text="${#numbers.formatDecimal(session.LvsCurrentUser.lvsCoin ?: 0, 0, 'COMMA', 0, 'POINT')}">0</span>
                                <span class="text-sm text-gray-400">coins</span>
                            </p>
                        </div>

                        <!-- Success/Error Messages -->
                        <div th:if="${success}"
                            class="bg-green-500/20 border border-green-500 text-green-400 px-4 py-3 rounded-lg mb-4">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span th:text="${success}"></span>
                        </div>
                        <div th:if="${error}"
                            class="bg-red-500/20 border border-red-500 text-red-400 px-4 py-3 rounded-lg mb-4">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            <span th:text="${error}"></span>
                        </div>

                        <!-- Buy Now Form (if not purchased) -->
                        <form th:if="${session.LvsCurrentUser != null and !LvsHasPurchased}"
                            th:action="@{/LvsUser/LvsProject/LvsPurchase/{id}(id=${project.lvsProjectId})}"
                            method="post" onsubmit="return confirm('Bạn có chắc chắn muốn mua dự án này?');">
                            <!-- CSRF Token -->
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                            <!-- Buy Button -->
                            <button type="submit" th:disabled="${session.LvsCurrentUser.lvsCoin < project.lvsPrice}"
                                class="w-full bg-[#fed700] text-black font-bold py-4 rounded-lg hover:bg-white transition shadow-lg mb-3 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-bolt"></i> Buy Now
                            </button>

                            <!-- Insufficient funds warning -->
                            <p th:if="${session.LvsCurrentUser.lvsCoin < project.lvsPrice}"
                                class="text-red-400 text-sm text-center mb-3">
                                <i class="fas fa-exclamation-triangle"></i> Insufficient coins
                            </p>
                        </form>

                        <!-- Already Purchased State -->
                        <div th:if="${session.LvsCurrentUser != null and LvsHasPurchased}"
                            class="bg-green-500/20 border border-green-500 rounded-lg p-4 mb-3 text-center">
                            <i class="fas fa-check-circle text-green-400 text-2xl mb-2"></i>
                            <p class="text-green-400 font-bold">You already own this project</p>
                        </div>

                        <!-- Login Required -->
                        <div th:unless="${session.LvsCurrentUser}" class="text-center">
                            <a th:href="@{/LvsLogin}"
                                class="block w-full bg-[#fed700] text-black font-bold py-4 rounded-lg hover:bg-white transition shadow-lg mb-3">
                                <i class="fas fa-sign-in-alt mr-2"></i>Login to Purchase
                            </a>
                        </div>

                        <!-- Add to Cart (if not purchased) -->
                        <form th:if="${session.LvsCurrentUser != null and !LvsHasPurchased}"
                            th:action="@{/LvsUser/LvsCart/LvsAddItem}" method="post" class="mb-3">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <input type="hidden" name="lvsProjectId" th:value="${project.lvsProjectId}">
                            <input type="hidden" name="lvsQuantity" value="1">
                            <button type="submit"
                                class="w-full bg-[#1e1e1e] border border-[#444] text-white font-bold py-3 rounded-lg hover:border-[#fed700] transition flex items-center justify-center gap-2">
                                <i class="fas fa-shopping-cart"></i> Add to Cart
                            </button>
                        </form>

                        <!-- Gift Button (only for project owner) -->
                        <button
                            th:if="${session.LvsCurrentUser != null and session.LvsCurrentUser.lvsUserId == project.lvsUser.lvsUserId and LvsFollowers != null and !LvsFollowers.isEmpty()}"
                            onclick="showGiftModal()"
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition flex items-center justify-center gap-2 mb-3">
                            <i class="fas fa-gift"></i> Gift to Follower
                        </button>

                        <!-- Wishlist -->
                        <button
                            class="w-full bg-transparent border border-[#444] text-gray-400 font-bold py-3 rounded-lg hover:border-[#fed700] hover:text-[#fed700] transition flex items-center justify-center gap-2">
                            <i class="far fa-heart"></i> Add to Wishlist
                        </button>

                        <!-- Project Info -->
                        <div class="border-t border-[#333] mt-6 pt-6 space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Project ID:</span>
                                <span class="text-white font-mono" th:text="'#' + ${project.lvsProjectId}">#001</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Created:</span>
                                <span class="text-white"
                                    th:text="${#temporals.format(project.lvsCreatedAt, 'dd/MM/yyyy')}">Date</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Last Updated:</span>
                                <span class="text-white"
                                    th:text="${#temporals.format(project.lvsUpdatedAt, 'dd/MM/yyyy')}">Date</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Gift Modal -->
        <div id="giftModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
            <div class="bg-[#2b2b2b] border border-[#333] rounded-xl p-8 max-w-md w-full">
                <h2 class="text-2xl font-bold text-white mb-6">
                    <i class="fas fa-gift text-purple-500 mr-2"></i>Gift Project
                </h2>

                <form th:action="@{/LvsUser/LvsGift/LvsSend}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <input type="hidden" name="projectId" th:value="${project.lvsProjectId}">

                    <!-- Select Follower -->
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2">Select Follower</label>
                        <select name="recipientId" required
                            class="w-full bg-[#1e1e1e] border border-[#333] text-white px-4 py-3 rounded-lg focus:border-purple-500 focus:outline-none">
                            <option value="">Choose a follower...</option>
                            <option th:each="follower : ${LvsFollowers}" th:value="${follower.lvsUserId}"
                                th:text="${follower.lvsUsername}">Follower</option>
                        </select>
                    </div>

                    <!-- Gift Message -->
                    <div class="mb-6">
                        <label class="block text-gray-400 mb-2">Message (Optional)</label>
                        <textarea name="message" rows="3"
                            class="w-full bg-[#1e1e1e] border border-[#333] text-white px-4 py-3 rounded-lg focus:border-purple-500 focus:outline-none"
                            placeholder="Add a personal message..."></textarea>
                    </div>

                    <!-- Buttons -->
                    <div class="flex gap-3">
                        <button type="submit"
                            class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition">
                            <i class="fas fa-gift mr-2"></i>Send Gift
                        </button>
                        <button type="button" onclick="hideGiftModal()"
                            class="flex-1 bg-[#1e1e1e] hover:bg-[#333] text-white font-bold py-3 rounded-lg transition">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            // Image Gallery Management
            let projectImages = [];
            let currentImageIndex = 0;

            // Parse images from the lvsImages JSON field
            function initializeGallery() {
                const lvsImagesJson = /*[[${project.lvsImages != null ? project.lvsImages : ''}]]*/ '';
                const lvsThumbnailUrl = /*[[${project.lvsThumbnailUrl != null ? project.lvsThumbnailUrl : ''}]]*/ '';

                // Start with thumbnail if available
                if (lvsThumbnailUrl && lvsThumbnailUrl.trim() !== '') {
                    projectImages.push(lvsThumbnailUrl);
                }

                // Parse and add additional images from lvsImages JSON
                if (lvsImagesJson && lvsImagesJson.trim() !== '') {
                    try {
                        const additionalImages = JSON.parse(lvsImagesJson);
                        if (Array.isArray(additionalImages)) {
                            // Filter out the thumbnail to avoid duplicates
                            const uniqueImages = additionalImages.filter(img => img !== lvsThumbnailUrl);
                            projectImages = projectImages.concat(uniqueImages);
                        }
                    } catch (e) {
                        console.error('Error parsing project images:', e);
                    }
                }

                // Show gallery controls if there are multiple images
                if (projectImages.length > 1) {
                    const prevBtn = document.getElementById('prevBtn');
                    const nextBtn = document.getElementById('nextBtn');
                    const imageCounter = document.getElementById('imageCounter');
                    const thumbnailGallery = document.getElementById('thumbnailGallery');

                    if (prevBtn) prevBtn.classList.remove('hidden');
                    if (nextBtn) nextBtn.classList.remove('hidden');
                    if (imageCounter) imageCounter.classList.remove('hidden');
                    if (thumbnailGallery) thumbnailGallery.classList.remove('hidden');

                    // Update total images count
                    const totalImagesEl = document.getElementById('totalImages');
                    if (totalImagesEl) totalImagesEl.textContent = projectImages.length;

                    // Generate thumbnails
                    generateThumbnails();
                }
            }

            // Generate thumbnail gallery
            function generateThumbnails() {
                const container = document.getElementById('thumbnailContainer');
                if (!container) return;

                container.innerHTML = '';

                projectImages.forEach((imageUrl, index) => {
                    const thumbDiv = document.createElement('div');
                    thumbDiv.className = 'flex-shrink-0 cursor-pointer border-2 rounded-lg overflow-hidden transition ' +
                        (index === 0 ? 'border-[#fed700]' : 'border-transparent hover:border-[#444]');
                    thumbDiv.onclick = () => showImage(index);

                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.className = 'w-20 h-20 object-cover';
                    img.alt = 'Thumbnail ' + (index + 1);

                    thumbDiv.appendChild(img);
                    container.appendChild(thumbDiv);
                });
            }

            // Show specific image
            function showImage(index) {
                if (index < 0 || index >= projectImages.length) return;

                currentImageIndex = index;
                const mainImage = document.getElementById('mainImage');
                if (mainImage) {
                    mainImage.src = projectImages[index];
                }

                // Update counter
                const currentImageNum = document.getElementById('currentImageNum');
                if (currentImageNum) currentImageNum.textContent = index + 1;

                // Update thumbnail borders
                const container = document.getElementById('thumbnailContainer');
                if (!container) return;

                const thumbnails = container.children;
                for (let i = 0; i < thumbnails.length; i++) {
                    if (i === index) {
                        thumbnails[i].className = thumbnails[i].className.replace('border-transparent', 'border-[#fed700]');
                    } else {
                        thumbnails[i].className = thumbnails[i].className.replace('border-[#fed700]', 'border-transparent');
                    }
                }
            }

            // Change image (next/previous)
            function changeImage(direction) {
                let newIndex = currentImageIndex + direction;

                // Loop around
                if (newIndex < 0) {
                    newIndex = projectImages.length - 1;
                } else if (newIndex >= projectImages.length) {
                    newIndex = 0;
                }

                showImage(newIndex);
            }

            // Keyboard navigation
            document.addEventListener('keydown', function (e) {
                if (projectImages.length <= 1) return;

                if (e.key === 'ArrowLeft') {
                    changeImage(-1);
                } else if (e.key === 'ArrowRight') {
                    changeImage(1);
                }
            });

            // Initialize gallery on page load
            document.addEventListener('DOMContentLoaded', initializeGallery);

            // Quantity and Price Management
            function increaseQuantity() {
                const input = document.getElementById('quantity');
                const currentValue = parseInt(input.value) || 1;
                if (currentValue < 99) {
                    input.value = currentValue + 1;
                    updateTotalPrice();
                }
            }

            function decreaseQuantity() {
                const input = document.getElementById('quantity');
                const currentValue = parseInt(input.value) || 1;
                if (currentValue > 1) {
                    input.value = currentValue - 1;
                    updateTotalPrice();
                }
            }

            function updateTotalPrice() {
                const quantity = parseInt(document.getElementById('quantity').value) || 1;
                const priceElement = document.getElementById('totalPrice');
                const basePrice = parseFloat(priceElement.getAttribute('data-price')) || 0;
                const total = basePrice * quantity;

                // Format number with thousand separators
                priceElement.textContent = total.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            }

            // Confirm before purchase
            document.getElementById('buyNowForm')?.addEventListener('submit', function (e) {
                const quantity = parseInt(document.getElementById('quantity').value) || 1;
                const totalPrice = parseFloat(document.getElementById('totalPrice').getAttribute('data-price')) * quantity;
                const userBalance = parseFloat('[[${session.LvsCurrentUser?.lvsCoin ?: 0}]]');

                if (totalPrice > userBalance) {
                    e.preventDefault();
                    alert('Insufficient coins! You need ' + totalPrice.toLocaleString() + ' coins but only have ' + userBalance.toLocaleString() + ' coins.');
                    return false;
                }

                if (!confirm('Purchase this project for ' + totalPrice.toLocaleString() + ' coins?')) {
                    e.preventDefault();
                    return false;
                }
            });

            // Gift Modal Functions
            function showGiftModal() {
                document.getElementById('giftModal').classList.remove('hidden');
            }

            function hideGiftModal() {
                document.getElementById('giftModal').classList.add('hidden');
            }

            // Close modal on outside click
            document.getElementById('giftModal')?.addEventListener('click', function (e) {
                if (e.target === this) {
                    hideGiftModal();
                }
            });

            // Close modal on Escape key
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    hideGiftModal();
                }
            });
        </script>
    </th:block>
</body>

</html>