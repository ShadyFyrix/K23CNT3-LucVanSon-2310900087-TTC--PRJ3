<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{LvsAreas/LvsUsers/LvsLayout/LvsUser-layout}">

<head>
    <title>Sửa dự án - Electro Store</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="container mx-auto px-4 py-8 max-w-3xl">
            <h1 class="text-3xl font-bold text-white mb-8">
                <i class="fas fa-edit mr-3 text-[#fed700]"></i>Sửa dự án
            </h1>

            <!-- Error/Success Messages -->
            <div th:if="${error}" class="bg-red-500/20 border border-red-500 text-red-400 px-6 py-4 rounded-lg mb-6">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span th:text="${error}"></span>
            </div>

            <div class="bg-[#2b2b2b] border border-[#333] rounded-xl p-8">
                <form th:action="@{/LvsUser/LvsProject/LvsUpdate/{id}(id=${LvsProject.lvsProjectId})}" method="post"
                    th:object="${LvsProject}" enctype="multipart/form-data">

                    <!-- CSRF Token -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                    <!-- Hidden field for deleted images -->
                    <input type="hidden" id="deletedImagesInput" name="deletedImages" value="">

                    <!-- Project Name -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-300 mb-2">Tên dự án *</label>
                        <input type="text" th:field="*{lvsProjectName}" required
                            class="w-full bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-white focus:border-[#fed700] focus:outline-none">
                    </div>

                    <!-- Description -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-300 mb-2">Mô tả *</label>
                        <textarea th:field="*{lvsDescription}" rows="6" required
                            class="w-full bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-white focus:border-[#fed700] focus:outline-none"></textarea>
                    </div>

                    <!-- Price and Category -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-300 mb-2">Giá (Coins) *</label>
                            <input type="number" th:field="*{lvsPrice}" step="0.01" min="0" required
                                class="w-full bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-white focus:border-[#fed700] focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-300 mb-2">Danh mục</label>
                            <select th:field="*{lvsCategory.lvsCategoryId}"
                                class="w-full bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-white focus:border-[#fed700] focus:outline-none">
                                <option value="">Chọn danh mục</option>
                                <option th:each="cat : ${LvsCategories}" th:value="${cat.lvsCategoryId}"
                                    th:text="${cat.lvsCategoryName}">Category</option>
                            </select>
                        </div>
                    </div>

                    <!-- Current Project File -->
                    <div class="mb-6" th:if="${LvsProject.lvsFileUrl}">
                        <label class="block text-sm font-bold text-gray-300 mb-2">
                            <i class="fas fa-file-archive text-[#fed700] mr-2"></i>File hiện tại
                        </label>
                        <div class="flex gap-2">
                            <input type="text" th:value="${LvsProject.lvsFileUrl}" readonly
                                class="flex-1 bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-gray-400">
                            <a th:href="${LvsProject.lvsFileUrl}" download
                                class="bg-[#fed700] text-black font-bold px-6 py-3 rounded-lg hover:bg-yellow-400 transition">
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                    </div>

                    <!-- New Project File Upload -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-300 mb-2">
                            <i class="fas fa-file-archive text-[#fed700] mr-2"></i>Thay đổi file dự án (ZIP/RAR)
                        </label>
                        <input type="file" name="projectFile" accept=".zip,.rar,.7z"
                            class="w-full bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-white focus:border-[#fed700] focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#fed700] file:text-black file:font-bold hover:file:bg-yellow-400">
                        <p class="text-sm text-gray-400 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>Chỉ upload nếu muốn thay đổi file hiện tại
                        </p>
                    </div>

                    <!-- Current Thumbnail -->
                    <div class="mb-6" th:if="${LvsProject.lvsThumbnailUrl}">
                        <label class="block text-sm font-bold text-gray-300 mb-2">Ảnh thumbnail hiện tại</label>
                        <img th:src="@{${LvsProject.lvsThumbnailUrl}}" alt="Current Thumbnail"
                            class="w-48 h-48 object-cover rounded-lg border border-[#444]">
                    </div>

                    <!-- New Thumbnail Upload -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-300 mb-2">
                            <i class="fas fa-image text-[#fed700] mr-2"></i>Thay đổi ảnh thumbnail
                        </label>
                        <input type="file" name="thumbnail" accept="image/*" id="thumbnailInput"
                            onchange="previewThumbnail(event)"
                            class="w-full bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-white focus:border-[#fed700] focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#fed700] file:text-black file:font-bold hover:file:bg-yellow-400">
                        <div id="thumbnailPreview" class="mt-4 hidden">
                            <img id="thumbnailImg" src="" alt="Preview"
                                class="w-48 h-48 object-cover rounded-lg border border-[#444]">
                        </div>
                    </div>

                    <!-- Existing Additional Images -->
                    <div class="mb-6" th:if="${LvsProject.lvsImages}">
                        <label class="block text-sm font-bold text-gray-300 mb-2">
                            <i class="fas fa-images text-[#fed700] mr-2"></i>Ảnh bổ sung hiện tại
                        </label>
                        <div id="existingAdditionalImages" class="grid grid-cols-3 gap-4"></div>
                    </div>

                    <!-- Additional Images Upload -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-300 mb-2">
                            <i class="fas fa-images text-[#fed700] mr-2"></i>Thêm ảnh bổ sung
                        </label>
                        <input type="file" name="additionalImages" accept="image/*" multiple id="imagesInput"
                            onchange="previewImages(event)"
                            class="w-full bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-white focus:border-[#fed700] focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#fed700] file:text-black file:font-bold hover:file:bg-yellow-400">
                        <div id="imagesPreview" class="mt-4 grid grid-cols-3 gap-4"></div>
                    </div>

                    <!-- Demo URL -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-300 mb-2">
                            <i class="fas fa-external-link-alt text-[#fed700] mr-2"></i>Demo URL
                        </label>
                        <input type="url" name="demoUrl" th:value="${LvsProject.lvsDemoUrl}"
                            placeholder="https://demo.example.com"
                            class="w-full bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-white focus:border-[#fed700] focus:outline-none">
                    </div>

                    <!-- Source Code URL -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-300 mb-2">
                            <i class="fab fa-github text-[#fed700] mr-2"></i>Source Code URL
                        </label>
                        <input type="url" name="sourceCodeUrl" th:value="${LvsProject.lvsSourceCodeUrl}"
                            placeholder="https://github.com/username/repo"
                            class="w-full bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-white focus:border-[#fed700] focus:outline-none">
                    </div>

                    <!-- Tags -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-300 mb-2">
                            <i class="fas fa-tags text-[#fed700] mr-2"></i>Tags
                        </label>
                        <input type="text" name="tags" th:value="${LvsProject.lvsTags}"
                            placeholder="java, spring boot, web app"
                            class="w-full bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-white focus:border-[#fed700] focus:outline-none">
                    </div>

                    <!-- ✨ DISCOUNT SETTINGS -->
                    <div
                        class="mb-6 bg-gradient-to-r from-orange-500/10 to-red-500/10 border-2 border-orange-500/50 rounded-xl p-6">
                        <h3 class="text-xl font-bold text-white mb-4">
                            <i class="fas fa-tag text-orange-400 mr-2"></i>Discount Settings (Sale)
                        </h3>

                        <!-- Enable Discount -->
                        <div class="mb-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" th:field="*{lvsIsOnSale}" id="lvsIsOnSale"
                                    class="w-5 h-5 text-orange-500 bg-[#1e1e1e] border-[#444] rounded focus:ring-orange-500">
                                <span class="ml-3 text-white font-semibold">
                                    <i class="fas fa-fire text-orange-400 mr-2"></i>Enable Discount (Put on Sale)
                                </span>
                            </label>
                            <p class="text-sm text-gray-400 mt-2 ml-8">Check this to activate discount for your project
                            </p>
                        </div>

                        <div id="discountFields" class="space-y-4">
                            <!-- Discount Percentage -->
                            <div>
                                <label class="block text-sm font-bold text-gray-300 mb-2">
                                    Discount Percentage
                                </label>
                                <div class="flex items-center gap-4">
                                    <input type="number" th:field="*{lvsDiscountPercent}" min="0" max="100"
                                        placeholder="30"
                                        class="flex-1 bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-white focus:border-orange-500 focus:outline-none">
                                    <span class="text-2xl font-bold text-orange-400">%</span>
                                </div>
                                <p class="text-sm text-gray-400 mt-1">Enter 0-100 (e.g., 30 for 30% OFF)</p>
                            </div>

                            <!-- Date Range -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-300 mb-2">
                                        <i class="fas fa-calendar-alt text-green-400 mr-2"></i>Start Date/Time
                                    </label>
                                    <input type="datetime-local" th:field="*{lvsDiscountStartDate}"
                                        class="w-full bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-white focus:border-green-500 focus:outline-none">
                                    <p class="text-xs text-gray-500 mt-1">Leave empty to start now</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-300 mb-2">
                                        <i class="fas fa-calendar-times text-red-400 mr-2"></i>End Date/Time
                                    </label>
                                    <input type="datetime-local" th:field="*{lvsDiscountEndDate}"
                                        class="w-full bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-white focus:border-red-500 focus:outline-none">
                                    <p class="text-xs text-gray-500 mt-1">Leave empty for no expiration</p>
                                </div>
                            </div>

                            <!-- Preview -->
                            <div class="bg-[#1e1e1e] border border-orange-500/30 rounded-lg p-4">
                                <h4 class="font-bold text-orange-400 mb-2">
                                    <i class="fas fa-eye mr-2"></i>Preview
                                </h4>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Original Price:</span>
                                        <span class="text-white font-bold">
                                            <span class="preview-original-price"
                                                th:text="${LvsProject.lvsPrice}">1000</span> coins
                                        </span>
                                    </div>
                                    <div class="preview-discount-row flex justify-between text-orange-400"
                                        style="display:none;">
                                        <span>Discount (<span class="preview-discount-percent">0</span>%):</span>
                                        <span class="font-bold">
                                            -<span class="preview-discount-amount">0</span> coins
                                        </span>
                                    </div>
                                    <div class="flex justify-between border-t border-[#444] pt-2 mt-2">
                                        <span class="text-white font-bold">Final Price:</span>
                                        <span class="text-[#fed700] font-bold text-lg">
                                            <span class="preview-final-price"
                                                th:text="${LvsProject.lvsFinalPrice}">1000</span> coins
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="flex gap-4">
                        <button type="submit"
                            class="flex-1 bg-[#fed700] text-black font-bold py-3 rounded-lg hover:bg-yellow-400 transition">
                            <i class="fas fa-save mr-2"></i>Cập nhật dự án
                        </button>
                        <a th:href="@{/LvsUser/LvsProject/LvsMyProjects}"
                            class="flex-1 bg-[#1e1e1e] border border-[#444] text-white font-bold py-3 rounded-lg hover:border-[#fed700] transition text-center">
                            Hủy
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript for Image Preview -->
    <script layout:fragment="scripts" th:inline="javascript">
        // Track deleted images
        const deletedImages = [];

        // Load existing additional images on page load
        document.addEventListener('DOMContentLoaded', function () {
            /*<![CDATA[*/
            const existingImagesJson = /*[[${LvsProject.lvsImages}]]*/ '';
            console.log('Existing images JSON:', existingImagesJson);
            console.log('Type:', typeof existingImagesJson);
            console.log('Length:', existingImagesJson ? existingImagesJson.length : 0);

            if (existingImagesJson && existingImagesJson.trim() !== '' && existingImagesJson !== 'null') {
                try {
                    const images = JSON.parse(existingImagesJson);
                    console.log('Parsed images:', images);
                    console.log('Is array:', Array.isArray(images));

                    const container = document.getElementById('existingAdditionalImages');
                    console.log('Container found:', container);

                    const contextPath = '/lvsforum'; // Hardcoded context path

                    if (container && Array.isArray(images) && images.length > 0) {
                        console.log('Loading', images.length, 'images');
                        images.forEach((imageUrl, index) => {
                            // Add context path if not present
                            const fullUrl = imageUrl.startsWith('/lvsforum') ? imageUrl : contextPath + imageUrl;
                            console.log('Image', index, 'URL:', fullUrl);

                            const div = document.createElement('div');
                            div.className = 'relative';
                            div.innerHTML = `
                                <img src="${fullUrl}" alt="Image ${index + 1}" 
                                     class="w-full h-32 object-cover rounded-lg border border-[#444]">
                                <button type="button" 
                                        onclick="deleteExistingImage('${imageUrl}', this)"
                                        class="absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            container.appendChild(div);
                        });
                        console.log('Images loaded successfully');
                    } else {
                        console.log('Container or images missing:', {
                            hasContainer: !!container,
                            isArray: Array.isArray(images),
                            imagesLength: images ? images.length : 0
                        });
                    }
                } catch (e) {
                    console.error('Error loading existing images:', e);
                    console.error('JSON that failed:', existingImagesJson);
                }
            } else {
                console.log('No existing images JSON found or empty/null');
            }
            /*]]>*/
        });

        // Update hidden input before form submit
        document.querySelector('form').addEventListener('submit', function (e) {
            // Populate hidden input with deleted images JSON
            document.getElementById('deletedImagesInput').value = JSON.stringify(deletedImages);
            console.log('Submitting with deleted images:', deletedImages);
        });

        function previewThumbnail(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('thumbnailImg').src = e.target.result;
                    document.getElementById('thumbnailPreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function previewImages(event) {
            const files = event.target.files;
            const preview = document.getElementById('imagesPreview');
            preview.innerHTML = '';

            Array.from(files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const div = document.createElement('div');
                        div.className = 'relative';
                        div.innerHTML = `
                            <img src="${e.target.result}" alt="Preview ${index + 1}" 
                                 class="w-full h-32 object-cover rounded-lg border border-[#444]">
                        `;
                        preview.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Delete existing image function
        function deleteExistingImage(imageUrl, button) {
            if (confirm('Bạn có chắc muốn xóa ảnh này?')) {
                // Add to deleted list
                deletedImages.push(imageUrl);
                console.log('Marked for deletion:', imageUrl);
                console.log('Total deleted:', deletedImages.length);

                // Remove from DOM
                button.closest('.relative').remove();

                // Note: Actual deletion will happen on form submit
                // You need to send deletedImages array to server
                alert('Ảnh sẽ bị xóa khi bạn lưu form!');
            }
        }

        // ✨ REAL-TIME DISCOUNT PREVIEW
        document.addEventListener('DOMContentLoaded', function () {
            const priceInput = document.querySelector('[name="lvsPrice"]');
            const discountInput = document.querySelector('[name="lvsDiscountPercent"]');
            const isOnSaleCheckbox = document.querySelector('#lvsIsOnSale');

            function updatePreview() {
                const price = parseFloat(priceInput.value) || 0;
                const discount = parseInt(discountInput.value) || 0;
                const isOnSale = isOnSaleCheckbox.checked;

                const discountAmount = isOnSale ? (price * discount / 100) : 0;
                const finalPrice = price - discountAmount;

                // Update preview display
                const originalPriceEl = document.querySelector('.preview-original-price');
                const discountAmountEl = document.querySelector('.preview-discount-amount');
                const discountPercentEl = document.querySelector('.preview-discount-percent');
                const finalPriceEl = document.querySelector('.preview-final-price');
                const discountRow = document.querySelector('.preview-discount-row');

                if (originalPriceEl) originalPriceEl.textContent = price.toFixed(1);
                if (discountAmountEl) discountAmountEl.textContent = discountAmount.toFixed(1);
                if (discountPercentEl) discountPercentEl.textContent = discount;
                if (finalPriceEl) finalPriceEl.textContent = finalPrice.toFixed(1);

                // Show/hide discount row
                if (discountRow) {
                    if (isOnSale && discount > 0) {
                        discountRow.style.display = 'flex';
                    } else {
                        discountRow.style.display = 'none';
                    }
                }
            }

            // Add event listeners
            if (priceInput) priceInput.addEventListener('input', updatePreview);
            if (discountInput) discountInput.addEventListener('input', updatePreview);
            if (isOnSaleCheckbox) isOnSaleCheckbox.addEventListener('change', updatePreview);

            // Initial update
            updatePreview();
        });
    </script>
</body>

</html>