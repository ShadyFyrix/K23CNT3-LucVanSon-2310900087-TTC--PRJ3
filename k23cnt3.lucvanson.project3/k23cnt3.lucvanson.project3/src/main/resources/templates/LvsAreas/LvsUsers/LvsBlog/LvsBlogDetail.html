<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" layout:decorate="~{LvsAreas/LvsUsers/LvsLayout/LvsUser-layout}">

<head>
    <title th:text="${LvsPost.lvsTitle != null and !LvsPost.lvsTitle.isEmpty()} ? ${LvsPost.lvsTitle} : 'Post'">Post
    </title>
    <meta th:name="_csrf" th:content="${_csrf.token}" />
    <meta th:name="_csrf_header" th:content="${_csrf.headerName}" />
    <!-- Title Effects CSS -->
    <link rel="stylesheet" th:href="@{/css/lvs-title-effects.css}">
</head>

<body>
    <div layout:fragment="content" class="min-h-screen bg-[#18191a] p-4">
        <div class="max-w-[680px] mx-auto">

            <!-- Post Card -->
            <article class="bg-[#242526] rounded-lg shadow-2xl mb-4">
                <!-- Post Header -->
                <div class="p-4">
                    <div class="flex items-start gap-3 mb-4">
                        <!-- Avatar with profile link -->
                        <a th:href="@{/LvsUser/LvsProfile/LvsView/{id}(id=${LvsPost.lvsUser.lvsUserId})}"
                            class="flex-shrink-0">
                            <div th:if="${LvsPost.lvsUser.lvsAvatarUrl != null and !LvsPost.lvsUser.lvsAvatarUrl.isEmpty()}"
                                class="w-12 h-12 rounded-full overflow-hidden ring-2 ring-[#3a3b3c]">
                                <img th:src="@{${LvsPost.lvsUser.lvsAvatarUrl}}" alt="Avatar"
                                    class="w-full h-full object-cover">
                            </div>
                            <div th:unless="${LvsPost.lvsUser.lvsAvatarUrl != null and !LvsPost.lvsUser.lvsAvatarUrl.isEmpty()}"
                                class="w-12 h-12 rounded-full bg-gradient-to-br from-[#fed700] to-[#ffa500] flex items-center justify-center text-black font-bold text-lg">
                                <span
                                    th:text="${#strings.substring(LvsPost.lvsUser.lvsUsername, 0, 1).toUpperCase()}">U</span>
                            </div>
                        </a>

                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <a th:href="@{/LvsUser/LvsProfile/LvsView/{id}(id=${LvsPost.lvsUser.lvsUserId})}"
                                    class="font-bold text-white hover:underline text-lg"
                                    th:text="${LvsPost.lvsUser.lvsUsername}">Username</a>
                                <!-- User Title Badge -->
                                <span th:if="${LvsPost.lvsUser.lvsTitle != null}"
                                    th:classappend="${LvsPost.lvsUser.lvsTitle.name() == 'ADMIN'} ? 'rainbow-text' : ''"
                                    th:style="${LvsPost.lvsUser.lvsTitle.name() != 'ADMIN'} ? 'color: ' + ${LvsPost.lvsUser.lvsTitle.color} : ''"
                                    th:text="${LvsPost.lvsUser.lvsTitle.displayName}"
                                    class="text-xs font-bold px-2 py-1 rounded">
                                </span>
                            </div>
                            <div class="flex items-center gap-2 text-sm text-gray-400">
                                <span
                                    th:text="${#temporals.format(LvsPost.lvsCreatedAt, 'dd MMM yyyy HH:mm')}">Date</span>
                                <span>Â·</span>
                                <span th:text="${LvsPost.lvsType.name()}" class="text-[#fed700]">Type</span>
                            </div>
                        </div>

                        <!-- Edit/Delete Menu (if author) -->
                        <div th:if="${LvsIsAuthor}" class="relative">
                            <button onclick="toggleMenu()"
                                class="w-9 h-9 flex items-center justify-center hover:bg-[#3a3b3c] rounded-full transition-colors">
                                <i class="fas fa-ellipsis-h text-gray-400"></i>
                            </button>
                            <div id="postMenu"
                                class="hidden absolute right-0 mt-2 w-48 bg-[#3a3b3c] rounded-lg shadow-xl z-10">
                                <a th:href="@{/LvsUser/LvsBlog/LvsEdit/{id}(id=${LvsPost.lvsPostId})}"
                                    class="block px-4 py-3 text-white hover:bg-[#4e4f50] rounded-t-lg">
                                    <i class="fas fa-edit mr-2"></i>Edit Post
                                </a>
                                <form th:action="@{/LvsUser/LvsBlog/LvsDelete/{id}(id=${LvsPost.lvsPostId})}"
                                    method="post" onsubmit="return confirm('Delete this post?');">
                                    <button type="submit"
                                        class="w-full text-left px-4 py-3 text-red-400 hover:bg-[#4e4f50] rounded-b-lg">
                                        <i class="fas fa-trash mr-2"></i>Delete Post
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Report Button (for non-authors) -->
                        <a th:unless="${LvsIsAuthor}"
                            th:href="@{/LvsUser/LvsReport/LvsCreate(lvsReportType='POST', lvsTargetId=${LvsPost.lvsPostId})}"
                            class="w-9 h-9 flex items-center justify-center hover:bg-red-600/20 rounded-full transition-colors"
                            title="Report this post">
                            <i class="fas fa-flag text-red-400"></i>
                        </a>
                    </div>

                    <!-- Post Title -->
                    <div th:if="${LvsPost.lvsTitle != null and !LvsPost.lvsTitle.isEmpty()}" class="mb-3">
                        <h1 class="text-2xl font-bold text-white" th:text="${LvsPost.lvsTitle}">Post Title</h1>
                    </div>

                    <!-- Post Content -->
                    <div class="text-gray-300 text-lg whitespace-pre-wrap mb-3" th:utext="${LvsPost.lvsContent}">
                        Post content...
                    </div>

                    <!-- Tags -->
                    <div th:if="${LvsPost.lvsTags != null and !LvsPost.lvsTags.isEmpty()}"
                        class="flex flex-wrap gap-2 mb-3">
                        <span th:each="tag : ${#strings.arraySplit(LvsPost.lvsTags, ',')}"
                            class="px-3 py-1 bg-[#3a3b3c] text-[#fed700] text-sm rounded-full hover:bg-[#4e4f50] cursor-pointer">
                            #<span th:text="${#strings.trim(tag)}">tag</span>
                        </span>
                    </div>
                </div>

                <!-- Post Images -->
                <div th:if="${LvsPost.lvsImages != null and !LvsPost.lvsImages.isEmpty()}">
                    <div th:if="${#lists.size(LvsPost.lvsImages) == 1}">
                        <img th:src="@{${LvsPost.lvsImages[0].lvsImageUrl}}" alt="Post image"
                            class="w-full max-h-[600px] object-contain bg-black">
                    </div>
                    <div th:if="${#lists.size(LvsPost.lvsImages) > 1}" class="grid grid-cols-2 gap-1">
                        <img th:each="image : ${LvsPost.lvsImages}" th:src="@{${image.lvsImageUrl}}" alt="Post image"
                            class="w-full aspect-square object-cover cursor-pointer hover:opacity-90 transition-opacity">
                    </div>
                </div>

                <!-- Post Stats -->
                <div class="px-4 py-3 flex items-center justify-between text-sm border-t border-[#3a3b3c]">
                    <div class="flex gap-4 text-gray-400">
                        <span><i class="fas fa-eye mr-1"></i><span th:text="${LvsPost.lvsViewCount}">0</span></span>
                        <span><i class="fas fa-heart mr-1"></i><span th:text="${LvsPost.lvsLikeCount}">0</span></span>
                    </div>
                    <span class="text-gray-400"><span th:text="${LvsPost.lvsCommentCount}">0</span> comments</span>
                </div>

                <!-- Post Actions -->
                <div class="border-t border-[#3a3b3c] px-2 py-1 flex gap-1">
                    <button th:onclick="|toggleLike(${LvsPost.lvsPostId})|" id="likeBtn"
                        class="flex-1 flex items-center justify-center gap-2 py-2.5 hover:bg-[#3a3b3c] rounded-lg transition-colors">
                        <i class="far fa-heart text-gray-400 text-lg" id="likeIcon"></i>
                        <span class="text-gray-300 font-medium">Like (<span id="likeCount"
                                th:text="${LvsPost.lvsLikeCount}">0</span>)</span>
                    </button>
                    <button onclick="document.getElementById('commentInput').focus()"
                        class="flex-1 flex items-center justify-center gap-2 py-2.5 hover:bg-[#3a3b3c] rounded-lg transition-colors">
                        <i class="far fa-comment text-gray-400 text-lg"></i>
                        <span class="text-gray-300 font-medium">Comment</span>
                    </button>
                    <button onclick="sharePost()"
                        class="flex-1 flex items-center justify-center gap-2 py-2.5 hover:bg-[#3a3b3c] rounded-lg transition-colors">
                        <i class="far fa-share-square text-gray-400 text-lg"></i>
                        <span class="text-gray-300 font-medium">Share</span>
                    </button>
                </div>
            </article>

            <!-- Comments Section -->
            <div class="bg-[#242526] rounded-lg shadow-2xl p-4">
                <h2 class="text-xl font-bold text-white mb-4">
                    Comments (<span th:text="${LvsPost.lvsCommentCount}">0</span>)
                </h2>

                <!-- Comment Form -->
                <form th:action="@{/LvsUser/LvsComment/LvsAdd}" method="post" enctype="multipart/form-data"
                    class="mb-6">
                    <input type="hidden" name="lvsPostId" th:value="${LvsPost.lvsPostId}">
                    <input type="hidden" name="lvsParentId" id="lvsParentId" value="">

                    <div class="flex gap-3">
                        <!-- User Avatar -->
                        <div th:if="${session.LvsCurrentUser.lvsAvatarUrl != null and !session.LvsCurrentUser.lvsAvatarUrl.isEmpty()}"
                            class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0">
                            <img th:src="@{${session.LvsCurrentUser.lvsAvatarUrl}}" alt="Avatar"
                                class="w-full h-full object-cover">
                        </div>
                        <div th:unless="${session.LvsCurrentUser.lvsAvatarUrl != null and !session.LvsCurrentUser.lvsAvatarUrl.isEmpty()}"
                            class="w-10 h-10 rounded-full bg-gradient-to-br from-[#fed700] to-[#ffa500] flex items-center justify-center text-black font-bold flex-shrink-0">
                            <span
                                th:text="${#strings.substring(session.LvsCurrentUser.lvsUsername, 0, 1).toUpperCase()}">U</span>
                        </div>

                        <div class="flex-1">
                            <div class="bg-[#3a3b3c] rounded-2xl px-4 py-2">
                                <textarea name="lvsContent" required rows="1" id="commentInput"
                                    placeholder="Write a comment..."
                                    class="w-full bg-transparent text-white placeholder-gray-500 border-none focus:outline-none resize-none"
                                    oninput="autoResize(this)"></textarea>
                            </div>

                            <!-- Comment Actions -->
                            <div class="flex items-center gap-3 mt-2 px-2">
                                <label class="cursor-pointer text-gray-400 hover:text-[#fed700] transition-colors">
                                    <i class="far fa-image"></i>
                                    <input type="file" name="images" multiple accept="image/*,.gif" class="hidden"
                                        onchange="previewCommentImage(this)">
                                </label>
                                <button type="button" onclick="insertEmojiComment()"
                                    class="text-gray-400 hover:text-[#fed700] transition-colors">
                                    <i class="far fa-smile"></i>
                                </button>
                                <button type="submit"
                                    class="ml-auto text-[#fed700] hover:text-[#ffa500] font-medium transition-colors">
                                    Post
                                </button>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Comments List -->
                <div th:if="${LvsComments != null and !LvsComments.content.isEmpty()}" class="space-y-4">
                    <div th:each="comment : ${LvsComments.content}" class="flex gap-3">
                        <!-- Comment Avatar -->
                        <a th:href="@{/LvsUser/LvsProfile/LvsView/{id}(id=${comment.lvsUser.lvsUserId})}"
                            class="flex-shrink-0">
                            <div th:if="${comment.lvsUser.lvsAvatarUrl != null and !comment.lvsUser.lvsAvatarUrl.isEmpty()}"
                                class="w-10 h-10 rounded-full overflow-hidden">
                                <img th:src="@{${comment.lvsUser.lvsAvatarUrl}}" alt="Avatar"
                                    class="w-full h-full object-cover">
                            </div>
                            <div th:unless="${comment.lvsUser.lvsAvatarUrl != null and !comment.lvsUser.lvsAvatarUrl.isEmpty()}"
                                class="w-10 h-10 rounded-full bg-gradient-to-br from-[#fed700] to-[#ffa500] flex items-center justify-center text-black font-bold">
                                <span
                                    th:text="${#strings.substring(comment.lvsUser.lvsUsername, 0, 1).toUpperCase()}">U</span>
                            </div>
                        </a>

                        <div class="flex-1">
                            <div class="bg-[#3a3b3c] rounded-2xl px-4 py-2">
                                <div class="flex items-center gap-2 mb-1">
                                    <a th:href="@{/LvsUser/LvsProfile/LvsView/{id}(id=${comment.lvsUser.lvsUserId})}"
                                        class="font-bold text-white hover:underline text-sm"
                                        th:text="${comment.lvsUser.lvsUsername}">User</a>
                                    <!-- User Title in Comment -->
                                    <span th:if="${comment.lvsUser.lvsTitle != null}"
                                        th:classappend="${comment.lvsUser.lvsTitle.name() == 'ADMIN'} ? 'rainbow-text' : ''"
                                        th:style="${comment.lvsUser.lvsTitle.name() != 'ADMIN'} ? 'color: ' + ${comment.lvsUser.lvsTitle.color} : ''"
                                        th:text="${comment.lvsUser.lvsTitle.displayName}"
                                        class="text-xs font-bold px-1.5 py-0.5 rounded">
                                    </span>
                                </div>
                                <p class="text-gray-300 whitespace-pre-wrap" th:text="${comment.lvsContent}">Comment
                                    text</p>

                                <!-- Comment Images/GIFs -->
                                <div th:if="${comment.lvsImages != null and !comment.lvsImages.isEmpty()}" class="mt-2">
                                    <img th:each="image : ${comment.lvsImages}" th:src="@{${image.lvsImageUrl}}"
                                        alt="Comment image" class="max-w-xs rounded-lg">
                                </div>
                            </div>

                            <!-- Comment Actions -->
                            <div class="flex items-center gap-4 px-4 mt-1 text-xs text-gray-400">
                                <span th:text="${#temporals.format(comment.lvsCreatedAt, 'dd MMM HH:mm')}">Date</span>
                                <button th:onclick="|toggleCommentLike(${comment.lvsCommentId})|"
                                    th:id="|comment-like-btn-${comment.lvsCommentId}|"
                                    class="hover:underline flex items-center gap-1">
                                    <i th:id="|comment-like-icon-${comment.lvsCommentId}|"
                                        class="far fa-heart text-xs"></i>
                                    Like
                                    <span th:if="${comment.lvsLikeCount > 0}">
                                        (<span th:id="|comment-like-count-${comment.lvsCommentId}|"
                                            th:text="${comment.lvsLikeCount}">0</span>)
                                    </span>
                                </button>
                                <button
                                    th:attr="onclick=|replyToComment('${comment.lvsUser.lvsUsername}', ${comment.lvsCommentId})|"
                                    class="hover:underline">Reply</button>
                                <a th:href="@{/LvsUser/LvsReport/LvsCreate(lvsReportType='COMMENT', lvsTargetId=${comment.lvsCommentId})}"
                                    class="text-red-400 hover:text-red-300 text-xs ml-3" title="Report comment">
                                    <i class="fas fa-flag"></i> Report
                                </a>

                                <!-- Delete button (only for own comments) -->
                                <form
                                    th:if="${session.LvsCurrentUser != null and session.LvsCurrentUser.lvsUserId == comment.lvsUser.lvsUserId}"
                                    th:action="@{/LvsUser/LvsComment/LvsDelete/{id}(id=${comment.lvsCommentId})}"
                                    method="post" style="display: inline;"
                                    onsubmit="return confirm('Are you sure you want to delete this comment?');">
                                    <button type="submit" class="hover:underline text-red-400">Delete</button>
                                </form>

                                <span th:if="${comment.lvsLikeCount > 0}">
                                    <i class="fas fa-heart text-red-500"></i>
                                    <span th:text="${comment.lvsLikeCount}">0</span>
                                </span>
                            </div>
                            <!-- NESTED REPLIES -->
                            <div th:if="${comment.lvsReplies != null and !comment.lvsReplies.isEmpty()}"
                                class="ml-12 mt-3 space-y-3">
                                <div th:each="reply : ${comment.lvsReplies}" class="flex gap-3">
                                    <!-- Reply avatar (smaller) -->
                                    <a th:href="@{/LvsUser/LvsProfile/LvsView/{id}(id=${reply.lvsUser.lvsUserId})}"
                                        class="flex-shrink-0">
                                        <div th:if="${reply.lvsUser.lvsAvatarUrl != null and !reply.lvsUser.lvsAvatarUrl.isEmpty()}"
                                            class="w-8 h-8 rounded-full overflow-hidden">
                                            <img th:src="@{${reply.lvsUser.lvsAvatarUrl}}" alt="Avatar"
                                                class="w-full h-full object-cover">
                                        </div>
                                        <div th:unless="${reply.lvsUser.lvsAvatarUrl != null and !reply.lvsUser.lvsAvatarUrl.isEmpty()}"
                                            class="w-8 h-8 rounded-full bg-gradient-to-br from-[#fed700] to-[#ffa500] flex items-center justify-center text-black font-bold text-xs"
                                            th:text="${#strings.substring(reply.lvsUser.lvsUsername, 0, 1).toUpperCase()}">
                                            U</div>
                                    </a>

                                    <!-- Reply content -->
                                    <div class="flex-1">
                                        <div class="bg-[#3a3b3c] rounded-2xl px-4 py-2 border-l-2 border-[#fed700]">
                                            <div class="flex items-center gap-2 mb-1">
                                                <a th:href="@{/LvsUser/LvsProfile/LvsView/{id}(id=${reply.lvsUser.lvsUserId})}"
                                                    class="font-bold text-white text-sm hover:underline"
                                                    th:text="${reply.lvsUser.lvsUsername}">Username</a>
                                                <!-- Reply User Title Badge -->
                                                <span th:if="${reply.lvsUser.lvsTitle != null}"
                                                    th:classappend="${reply.lvsUser.lvsTitle.name() == 'ADMIN'} ? 'rainbow-text' : ''"
                                                    th:style="${reply.lvsUser.lvsTitle.name() != 'ADMIN'} ? 'color: ' + ${reply.lvsUser.lvsTitle.color} : ''"
                                                    th:text="${reply.lvsUser.lvsTitle.displayName}"
                                                    class="text-xs font-bold px-1.5 py-0.5 rounded">
                                                </span>
                                            </div>
                                            <p class="text-gray-300 text-sm whitespace-pre-wrap"
                                                th:text="${reply.lvsContent}">Reply</p>

                                            <!-- Reply images -->
                                            <div th:if="${reply.lvsImages != null and !reply.lvsImages.isEmpty()}"
                                                class="mt-2 grid gap-2"
                                                th:classappend="${#lists.size(reply.lvsImages) == 1} ? 'grid-cols-1' : 'grid-cols-2'">
                                                <img th:each="image : ${reply.lvsImages}"
                                                    th:src="@{${image.lvsImageUrl}}" alt="Reply image"
                                                    class="max-w-xs rounded-lg cursor-pointer hover:opacity-90 transition-opacity">
                                            </div>
                                        </div>

                                        <!-- Reply actions -->
                                        <div class="flex items-center gap-4 px-4 mt-1 text-xs text-gray-400">
                                            <span
                                                th:text="${#temporals.format(reply.lvsCreatedAt, 'dd MMM HH:mm')}">Date</span>
                                            <button th:onclick="|toggleCommentLike(${reply.lvsCommentId})|"
                                                th:id="|comment-like-btn-${reply.lvsCommentId}|"
                                                class="hover:underline flex items-center gap-1">
                                                <i th:id="|comment-like-icon-${reply.lvsCommentId}|"
                                                    class="far fa-heart text-xs"></i>
                                                Like
                                                <span th:if="${reply.lvsLikeCount > 0}">
                                                    (<span th:id="|comment-like-count-${reply.lvsCommentId}|"
                                                        th:text="${reply.lvsLikeCount}">0</span>)
                                                </span>
                                            </button>
                                            <a th:href="@{/LvsUser/LvsReport/LvsCreate(lvsReportType='COMMENT', lvsTargetId=${reply.lvsCommentId})}"
                                                class="text-red-400 hover:text-red-300 text-xs ml-3"
                                                title="Report reply">
                                                <i class="fas fa-flag"></i> Report
                                            </a>

                                            <!-- Delete button for own replies -->
                                            <form
                                                th:if="${session.LvsCurrentUser != null and session.LvsCurrentUser.lvsUserId == reply.lvsUser.lvsUserId}"
                                                th:action="@{/LvsUser/LvsComment/LvsDelete/{id}(id=${reply.lvsCommentId})}"
                                                method="post" style="display: inline;"
                                                onsubmit="return confirm('Delete this reply?');">
                                                <button type="submit"
                                                    class="hover:underline text-red-400">Delete</button>
                                            </form>

                                            <span th:if="${reply.lvsLikeCount > 0}">
                                                <i class="fas fa-heart text-red-500"></i>
                                                <span th:text="${reply.lvsLikeCount}">0</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div th:if="${LvsComments == null or LvsComments.content.isEmpty()}" class="text-center py-8">
                    <i class="far fa-comments text-4xl text-gray-600 mb-2"></i>
                    <p class="text-gray-500">No comments yet. Be the first!</p>
                </div>
            </div>
        </div>

        <!-- Share Modal -->
        <div id="shareModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center"
            onclick="closeShareModalOnBackdrop(event)">
            <div class="bg-[#242526] rounded-lg p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-white">Share Post</h3>
                    <button onclick="closeShareModal()"
                        class="w-8 h-8 flex items-center justify-center hover:bg-[#3a3b3c] rounded-full">
                        <i class="fas fa-times text-gray-400"></i>
                    </button>
                </div>

                <!-- Option 1: Copy Link -->
                <button onclick="copyLink()"
                    class="w-full flex items-center gap-4 p-4 bg-[#3a3b3c] hover:bg-[#4e4f50] rounded-lg mb-3 transition-colors">
                    <div class="w-12 h-12 flex items-center justify-center bg-[#fed700]/20 rounded-full">
                        <i class="fas fa-link text-[#fed700] text-xl"></i>
                    </div>
                    <div class="text-left flex-1">
                        <div class="text-white font-bold">Copy Link</div>
                        <div class="text-gray-400 text-sm">Share link via clipboard</div>
                    </div>
                </button>

                <!-- Option 2: Share to Blog -->
                <button onclick="shareToBlog()"
                    class="w-full flex items-center gap-4 p-4 bg-[#3a3b3c] hover:bg-[#4e4f50] rounded-lg transition-colors">
                    <div class="w-12 h-12 flex items-center justify-center bg-[#fed700]/20 rounded-full">
                        <i class="fas fa-share-alt text-[#fed700] text-xl"></i>
                    </div>
                    <div class="text-left flex-1">
                        <div class="text-white font-bold">Share to Your Blog</div>
                        <div class="text-gray-400 text-sm">Create a post about this</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <script layout:fragment="scripts">
        const postId = /*[[${LvsPost.lvsPostId}]]*/ 0;

        function toggleMenu() {
            document.getElementById('postMenu').classList.toggle('hidden');
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function insertEmojiComment() {
            const emojis = ['ðŸ˜€', 'ðŸ˜‚', 'ðŸ˜', 'ðŸ¥°', 'ðŸ˜Ž', 'ðŸ¤”', 'ðŸ‘', 'â¤ï¸', 'ðŸ”¥', 'âœ¨', 'ðŸŽ‰', 'ðŸ’¯'];
            const emoji = emojis[Math.floor(Math.random() * emojis.length)];
            const textarea = document.getElementById('commentInput');
            textarea.value += emoji;
            autoResize(textarea);
        }

        // Like functionality
        function toggleLike(postId) {
            const btn = document.getElementById('likeBtn');

            // Prevent spam clicking
            if (btn.disabled) return;
            btn.disabled = true;
            btn.style.opacity = '0.6';

            // Check if already liked (session storage)
            let likedPosts = JSON.parse(sessionStorage.getItem('likedPosts') || '[]');
            const alreadyLiked = likedPosts.includes(postId);

            if (alreadyLiked) {
                showToast('You already liked this post!');
                setTimeout(() => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }, 1000);
                return;
            }

            console.log('Toggling like for post:', postId);

            const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

            fetch(`/lvsforum/LvsUser/LvsBlog/LvsLike/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const likeIcon = document.getElementById('likeIcon');
                        const likeCount = document.getElementById('likeCount');

                        if (data.liked) {
                            // Add to liked posts
                            likedPosts.push(postId);
                            sessionStorage.setItem('likedPosts', JSON.stringify(likedPosts));

                            likeIcon.classList.remove('far');
                            likeIcon.classList.add('fas', 'text-red-500');
                            showToast('Liked!');
                        } else {
                            // Remove from liked posts
                            likedPosts = likedPosts.filter(id => id !== postId);
                            sessionStorage.setItem('likedPosts', JSON.stringify(likedPosts));

                            likeIcon.classList.remove('fas', 'text-red-500');
                            likeIcon.classList.add('far');
                            showToast('Unliked!');
                        }

                        likeCount.textContent = data.likeCount;
                    } else {
                        alert(data.message || 'Please login to like posts');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error liking post');
                })
                .finally(() => {
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    }, 1000);
                });
        }

        // Share functionality - Open modal
        function sharePost() {
            document.getElementById('shareModal').classList.remove('hidden');
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.add('hidden');
        }

        function closeShareModalOnBackdrop(event) {
            if (event.target.id === 'shareModal') {
                closeShareModal();
            }
        }

        function copyLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied to clipboard!', 'success');
                closeShareModal();
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy link', 'error');
            });
        }

        // Comment Like functionality
        function toggleCommentLike(commentId) {
            const btn = document.getElementById(`comment-like-btn-${commentId}`);

            // Prevent spam
            if (btn.disabled) return;
            btn.disabled = true;
            btn.style.opacity = '0.6';

            // Check if already liked
            let likedComments = JSON.parse(sessionStorage.getItem('likedComments') || '[]');
            const alreadyLiked = likedComments.includes(commentId);

            if (alreadyLiked) {
                showToast('You already liked this comment!');
                setTimeout(() => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }, 1000);
                return;
            }

            const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

            fetch(`/lvsforum/LvsUser/LvsComment/LvsLike/${commentId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const icon = document.getElementById(`comment-like-icon-${commentId}`);
                        const countSpan = document.getElementById(`comment-like-count-${commentId}`);

                        if (data.liked) {
                            // Add to liked comments
                            likedComments.push(commentId);
                            sessionStorage.setItem('likedComments', JSON.stringify(likedComments));

                            if (icon) {
                                icon.classList.remove('far');
                                icon.classList.add('fas', 'text-red-500');
                            }
                            showToast('Liked comment!');
                        } else {
                            // Remove from liked comments
                            likedComments = likedComments.filter(id => id !== commentId);
                            sessionStorage.setItem('likedComments', JSON.stringify(likedComments));

                            if (icon) {
                                icon.classList.remove('fas', 'text-red-500');
                                icon.classList.add('far');
                            }
                            showToast('Unliked comment!');
                        }

                        if (countSpan) {
                            countSpan.textContent = data.likeCount;
                        }
                    } else {
                        alert(data.message || 'Please login');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error liking comment');
                })
                .finally(() => {
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    }, 1000);
                });
        }

        function shareToBlog() {
            const postTitle = /*[[${LvsPost.lvsTitle}]]*/ 'Post';
            const postUrl = window.location.href;
            const shareText = `Check out this post: ${postTitle}\n\n${postUrl}`;

            // Redirect to create post with pre-filled content
            window.location.href = `/lvsforum/LvsUser/LvsBlog/LvsCreate?content=${encodeURIComponent(shareText)}`;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-[#fed700]' : 'bg-red-500';
            toast.className = `fixed bottom-4 right-4 ${bgColor} text-black px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Reply to comment with @mention
        function replyToComment(username, commentId) {
            const input = document.getElementById('commentInput');
            const parentInput = document.getElementById('lvsParentId');

            if (input && parentInput) {
                input.value = '@' + username + ' ';
                parentInput.value = commentId;  // Set parent comment ID
                input.focus();
                input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                autoResize(input);
                showToast(`Replying to @${username}`);
            }
        }

        // Comment image preview
        function previewCommentImage(input) {
            // Remove old preview if exists
            const oldPreview = document.getElementById('commentImagePreview');
            if (oldPreview) oldPreview.remove();

            if (!input.files || input.files.length === 0) return;

            // Create preview container
            const preview = document.createElement('div');
            preview.id = 'commentImagePreview';
            preview.className = 'mt-2 flex gap-2 flex-wrap px-2';

            // Add preview images
            for (let i = 0; i < input.files.length; i++) {
                const file = input.files[i];
                const reader = new FileReader();

                reader.onload = function (e) {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'relative';

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'w-20 h-20 object-cover rounded border-2 border-[#fed700]';

                    imgContainer.appendChild(img);
                    preview.appendChild(imgContainer);
                };

                reader.readAsDataURL(file);
            }

            // Insert preview after comment actions
            const commentActions = input.closest('.flex-1');
            if (commentActions) {
                commentActions.appendChild(preview);
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', function (event) {
            const menu = document.getElementById('postMenu');
            if (menu && !event.target.closest('.relative')) {
                menu.classList.add('hidden');
            }
        });
    </script>
</body>

</html>