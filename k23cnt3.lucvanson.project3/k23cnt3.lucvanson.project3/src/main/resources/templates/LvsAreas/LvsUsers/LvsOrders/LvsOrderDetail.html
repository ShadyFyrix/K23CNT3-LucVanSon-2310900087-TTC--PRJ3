<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{LvsAreas/LvsUsers/LvsLayout/LvsUser-layout}">

<head>
    <title>Purchase Details - Electro Store</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="container mx-auto px-4 py-8 max-w-6xl">
            <!-- Back Button -->
            <a th:href="@{/LvsUser/LvsOrder/LvsMyOrders}"
                class="inline-flex items-center text-gray-400 hover:text-[#fed700] transition mb-6">
                <i class="fas fa-arrow-left mr-2"></i>Back to My Purchases
            </a>

            <!-- Header -->
            <div class="flex flex-wrap items-start justify-between gap-4 mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-white mb-2">
                        <i class="fas fa-file-invoice mr-3 text-[#fed700]"></i>
                        Purchase #<span th:text="${LvsOrder.lvsOrderId}">0</span>
                    </h1>
                    <p class="text-gray-400">
                        <i class="far fa-calendar mr-1"></i>
                        Purchased on <span
                            th:text="${#temporals.format(LvsOrder.lvsCreatedAt, 'dd MMMM yyyy, HH:mm')}">Date</span>
                    </p>
                </div>

                <!-- Status Badge -->
                <span th:class="${LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).PENDING ? 'bg-yellow-500/20 text-yellow-400 border-yellow-500' :
                                 LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).PROCESSING ? 'bg-blue-500/20 text-blue-400 border-blue-500' :
                                 LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).COMPLETED ? 'bg-green-500/20 text-green-400 border-green-500' :
                                 LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).CANCELLED ? 'bg-red-500/20 text-red-400 border-red-500' :
                                 LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).REFUNDED ? 'bg-orange-500/20 text-orange-400 border-orange-500' :
                                 'bg-gray-500/20 text-gray-400 border-gray-500'}"
                    class="px-6 py-3 rounded-full text-lg font-bold border">
                    <i th:class="${LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).PENDING ? 'fas fa-clock' :
                                  LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).PROCESSING ? 'fas fa-spinner fa-spin' :
                                  LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).COMPLETED ? 'fas fa-check-circle' :
                                  LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).CANCELLED ? 'fas fa-times-circle' :
                                  LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).REFUNDED ? 'fas fa-undo' :
                                  'fas fa-question'}" class="mr-2"></i>
                    <span th:text="${LvsOrder.lvsStatus}">Status</span>
                </span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Content -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Projects Purchased -->
                    <div class="bg-[#2b2b2b] border border-[#333] rounded-xl p-6">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                            <i class="fas fa-gamepad text-[#fed700] mr-3"></i>Projects Purchased
                        </h2>
                        <div class="space-y-4">
                            <div th:each="item : ${LvsOrder.lvsOrderItems}"
                                class="flex gap-4 pb-4 border-b border-[#444] last:border-0">
                                <!-- Project Thumbnail -->
                                <div
                                    class="w-24 h-24 bg-[#1e1e1e] rounded-lg flex items-center justify-center flex-shrink-0 overflow-hidden">
                                    <img th:if="${item.lvsProject?.lvsThumbnailUrl}"
                                        th:src="@{${item.lvsProject.lvsThumbnailUrl}}"
                                        class="w-full h-full object-cover" alt="Project">
                                    <i th:unless="${item.lvsProject?.lvsThumbnailUrl}"
                                        class="fas fa-gamepad text-gray-600 text-3xl"></i>
                                </div>

                                <!-- Project Info -->
                                <div class="flex-grow">
                                    <h3 class="text-white font-bold mb-2" th:text="${item.lvsProject?.lvsProjectName}">
                                        Project Name</h3>
                                    <p class="text-gray-400 text-sm mb-2">
                                        by <span class="text-[#fed700]"
                                            th:text="${item.lvsProject?.lvsUser?.lvsUsername ?: 'Unknown'}">Creator</span>
                                    </p>
                                    <div class="flex items-center gap-4 text-sm">
                                        <span class="text-gray-400">
                                            Quantity: <span class="text-white font-bold"
                                                th:text="${item.lvsQuantity}">1</span>
                                        </span>
                                        <span class="text-gray-400">Ã—</span>
                                        <span class="text-[#fed700] font-bold">
                                            <i class="fas fa-coins mr-1"></i>
                                            <span
                                                th:text="${#numbers.formatDecimal(item.lvsUnitPrice, 0, 'COMMA', 0, 'POINT')}">0</span>
                                        </span>
                                    </div>
                                </div>

                                <!-- Item Total -->
                                <div class="text-right">
                                    <p class="text-gray-400 text-sm mb-1">Subtotal:</p>
                                    <p class="text-white font-bold text-lg">
                                        <i class="fas fa-coins text-[#fed700] mr-1"></i>
                                        <span
                                            th:text="${#numbers.formatDecimal(item.lvsUnitPrice * item.lvsQuantity, 0, 'COMMA', 0, 'POINT')}">0</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Download Section (COMPLETED orders only) -->
                    <div th:if="${LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).COMPLETED}"
                        class="bg-[#2b2b2b] border border-[#333] rounded-xl p-6">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                            <i class="fas fa-download text-[#fed700] mr-3"></i>Download Your Projects
                        </h2>

                        <div class="space-y-6">
                            <div th:each="item : ${LvsOrder.lvsOrderItems}">
                                <!-- Project Name Header -->
                                <div class="border-b border-[#444] pb-3 mb-4">
                                    <h3 class="text-white font-bold text-lg flex items-center">
                                        <i class="fas fa-gamepad text-[#fed700] mr-2"></i>
                                        <span th:text="${item.lvsProject?.lvsProjectName}">Project Name</span>
                                    </h3>
                                </div>

                                <!-- Download Links -->
                                <div class="space-y-3">
                                    <!-- Main File -->
                                    <a th:if="${item.lvsProject?.lvsFileUrl != null and !#strings.isEmpty(item.lvsProject.lvsFileUrl)}"
                                        th:href="@{${item.lvsProject.lvsFileUrl}}" download
                                        class="flex items-center justify-between bg-[#1e1e1e] border border-[#444] rounded-lg p-4 hover:border-[#fed700] transition group">
                                        <div class="flex items-center gap-3">
                                            <div
                                                class="w-10 h-10 bg-[#fed700]/20 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-file-archive text-[#fed700]"></i>
                                            </div>
                                            <div>
                                                <p class="text-white font-bold">Main Project File</p>
                                                <p class="text-gray-400 text-sm">Complete project package</p>
                                            </div>
                                        </div>
                                        <i
                                            class="fas fa-download text-gray-400 group-hover:text-[#fed700] transition"></i>
                                    </a>

                                    <!-- Demo URL -->
                                    <a th:if="${item.lvsProject?.lvsDemoUrl != null and !#strings.isEmpty(item.lvsProject.lvsDemoUrl)}"
                                        th:href="@{${item.lvsProject.lvsDemoUrl}}" target="_blank"
                                        class="flex items-center justify-between bg-[#1e1e1e] border border-[#444] rounded-lg p-4 hover:border-[#fed700] transition group">
                                        <div class="flex items-center gap-3">
                                            <div
                                                class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-play-circle text-blue-400"></i>
                                            </div>
                                            <div>
                                                <p class="text-white font-bold">Live Demo</p>
                                                <p class="text-gray-400 text-sm">View working demo</p>
                                            </div>
                                        </div>
                                        <i
                                            class="fas fa-external-link-alt text-gray-400 group-hover:text-[#fed700] transition"></i>
                                    </a>

                                    <!-- Source Code -->
                                    <a th:if="${item.lvsProject?.lvsSourceCodeUrl != null and !#strings.isEmpty(item.lvsProject.lvsSourceCodeUrl)}"
                                        th:href="@{${item.lvsProject.lvsSourceCodeUrl}}" target="_blank"
                                        class="flex items-center justify-between bg-[#1e1e1e] border border-[#444] rounded-lg p-4 hover:border-[#fed700] transition group">
                                        <div class="flex items-center gap-3">
                                            <div
                                                class="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-code text-green-400"></i>
                                            </div>
                                            <div>
                                                <p class="text-white font-bold">Source Code</p>
                                                <p class="text-gray-400 text-sm">GitHub repository or source</p>
                                            </div>
                                        </div>
                                        <i
                                            class="fas fa-external-link-alt text-gray-400 group-hover:text-[#fed700] transition"></i>
                                    </a>

                                    <!-- Additional Files (from lvsFiles JSON) -->
                                    <div
                                        th:if="${item.lvsProject?.lvsFiles != null and !#strings.isEmpty(item.lvsProject.lvsFiles)}">
                                        <!-- Parse JSON and display files -->
                                        <div class="border-t border-[#444] pt-3 mt-3">
                                            <p class="text-gray-400 text-sm mb-2">Additional Files:</p>
                                            <!-- Note: JSON parsing would need JavaScript or server-side parsing -->
                                            <p class="text-gray-500 text-xs italic">Additional files available - contact
                                                support for access</p>
                                        </div>
                                    </div>

                                    <!-- No Files Available -->
                                    <div th:if="${(item.lvsProject?.lvsFileUrl == null or #strings.isEmpty(item.lvsProject.lvsFileUrl)) and
                                                   (item.lvsProject?.lvsDemoUrl == null or #strings.isEmpty(item.lvsProject.lvsDemoUrl)) and
                                                   (item.lvsProject?.lvsSourceCodeUrl == null or #strings.isEmpty(item.lvsProject.lvsSourceCodeUrl))}"
                                        class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                                        <div class="flex items-start gap-3">
                                            <i class="fas fa-info-circle text-yellow-400 mt-1"></i>
                                            <div>
                                                <p class="text-yellow-400 font-bold mb-1">No Download Links Available
                                                </p>
                                                <p class="text-gray-400 text-sm">The seller hasn't uploaded files yet.
                                                    Please contact them for access.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Buyer Information -->
                    <div class="bg-[#2b2b2b] border border-[#333] rounded-xl p-6">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                            <i class="fas fa-user text-[#fed700] mr-3"></i>Buyer Information
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-gray-400 text-sm mb-1">Username:</p>
                                <p class="text-white font-bold" th:text="${LvsOrder.lvsBuyer?.lvsUsername}">Username</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm mb-1">Email:</p>
                                <p class="text-white font-bold" th:text="${LvsOrder.lvsBuyer?.lvsEmail}">
                                    email@example.com</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm mb-1">Full Name:</p>
                                <p class="text-white font-bold" th:text="${LvsOrder.lvsBuyer?.lvsFullName ?: 'N/A'}">
                                    Full Name</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm mb-1">Phone:</p>
                                <p class="text-white font-bold" th:text="${LvsOrder.lvsBuyer?.lvsPhone ?: 'N/A'}">Phone
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Order Summary -->
                    <div class="bg-[#2b2b2b] border border-[#333] rounded-xl p-6 sticky top-4">
                        <h2 class="text-xl font-bold text-white mb-4">Order Summary</h2>

                        <div class="space-y-3 mb-6 pb-6 border-b border-[#333]">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">Order ID:</span>
                                <span class="text-white font-mono">#<span
                                        th:text="${LvsOrder.lvsOrderId}">0</span></span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">Status:</span>
                                <span class="text-white font-bold" th:text="${LvsOrder.lvsStatus}">Status</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">Date:</span>
                                <span class="text-white"
                                    th:text="${#temporals.format(LvsOrder.lvsCreatedAt, 'dd/MM/yyyy')}">Date</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">Payment Method:</span>
                                <span class="text-white">
                                    <i class="fas fa-coins text-[#fed700] mr-1"></i>Coins
                                </span>
                            </div>
                        </div>

                        <!-- Total -->
                        <div class="bg-[#1e1e1e] border border-[#444] rounded-lg p-4 mb-6">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400 font-bold">Total Paid:</span>
                                <span class="text-[#fed700] font-bold text-3xl">
                                    <i class="fas fa-coins mr-1"></i>
                                    <span
                                        th:text="${#numbers.formatDecimal(LvsOrder.lvsFinalAmount, 0, 'COMMA', 0, 'POINT')}">0</span>
                                </span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="space-y-3">
                            <!-- Pay Now (PENDING only) -->
                            <form
                                th:if="${LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).PENDING}"
                                th:action="@{/LvsUser/LvsOrder/LvsPay/{id}(id=${LvsOrder.lvsOrderId})}" method="post">
                                <button type="submit"
                                    class="w-full bg-[#fed700] text-black font-bold py-3 rounded-lg hover:bg-white transition flex items-center justify-center gap-2">
                                    <i class="fas fa-credit-card"></i> Pay Now
                                </button>
                            </form>

                            <!-- Cancel Order (PENDING or PROCESSING) -->
                            <button
                                th:if="${LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).PENDING or 
                                           LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).PROCESSING}"
                                onclick="showCancelModal()"
                                class="w-full bg-red-500/20 border border-red-500 text-red-400 font-bold py-3 rounded-lg hover:bg-red-500/30 transition flex items-center justify-center gap-2">
                                <i class="fas fa-times-circle"></i> Cancel Order
                            </button>

                            <!-- Download Invoice (COMPLETED) -->
                            <a th:if="${LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).COMPLETED}"
                                th:href="@{/LvsUser/LvsOrder/LvsInvoice/{id}(id=${LvsOrder.lvsOrderId})}"
                                target="_blank"
                                class="block w-full bg-[#1e1e1e] border border-[#444] text-white font-bold py-3 rounded-lg hover:border-[#fed700] transition text-center">
                                <i class="fas fa-download mr-2"></i>Download Invoice
                            </a>

                            <!-- Request Refund (COMPLETED) -->
                            <button
                                th:if="${LvsOrder.lvsStatus == T(k23cnt3.lucvanson.project3.LvsEntity.LvsOrder.LvsOrderStatus).COMPLETED}"
                                onclick="showRefundModal()"
                                class="w-full bg-[#1e1e1e] border border-[#444] text-gray-400 font-bold py-3 rounded-lg hover:border-[#fed700] hover:text-white transition flex items-center justify-center gap-2">
                                <i class="fas fa-undo"></i> Request Refund
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cancel Order Modal -->
        <div id="cancelModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50"
            onclick="if(event.target === this) hideCancelModal()">
            <div class="bg-[#2b2b2b] border border-[#333] rounded-xl p-8 max-w-md w-full mx-4">
                <h3 class="text-2xl font-bold text-white mb-4">
                    <i class="fas fa-exclamation-triangle text-red-400 mr-2"></i>Cancel Order
                </h3>
                <p class="text-gray-400 mb-6">Are you sure you want to cancel this order? This action cannot be undone.
                </p>

                <form th:action="@{/LvsUser/LvsOrder/LvsCancel/{id}(id=${LvsOrder.lvsOrderId})}" method="post">
                    <div class="mb-6">
                        <label class="text-gray-400 text-sm mb-2 block">Reason for cancellation (optional):</label>
                        <textarea name="lvsReason" rows="3"
                            class="w-full bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-white focus:border-[#fed700] focus:ring-0"
                            placeholder="Tell us why you're cancelling..."></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button type="button" onclick="hideCancelModal()"
                            class="flex-1 bg-[#1e1e1e] border border-[#444] text-white font-bold py-3 rounded-lg hover:border-[#fed700] transition">
                            Keep Order
                        </button>
                        <button type="submit"
                            class="flex-1 bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition">
                            Cancel Order
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Refund Request Modal -->
        <div id="refundModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50"
            onclick="if(event.target === this) hideRefundModal()">
            <div class="bg-[#2b2b2b] border border-[#333] rounded-xl p-8 max-w-md w-full mx-4">
                <h3 class="text-2xl font-bold text-white mb-4">
                    <i class="fas fa-undo text-[#fed700] mr-2"></i>Request Refund
                </h3>
                <p class="text-gray-400 mb-6">Please provide a reason for your refund request. Our team will review it
                    shortly.</p>

                <form th:action="@{/LvsUser/LvsOrder/LvsRequestRefund/{id}(id=${LvsOrder.lvsOrderId})}" method="post">
                    <div class="mb-6">
                        <label class="text-gray-400 text-sm mb-2 block">Reason for refund <span
                                class="text-red-400">*</span>:</label>
                        <textarea name="lvsReason" rows="4" required
                            class="w-full bg-[#1e1e1e] border border-[#444] rounded-lg px-4 py-3 text-white focus:border-[#fed700] focus:ring-0"
                            placeholder="Describe the issue with your purchase..."></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button type="button" onclick="hideRefundModal()"
                            class="flex-1 bg-[#1e1e1e] border border-[#444] text-white font-bold py-3 rounded-lg hover:border-[#fed700] transition">
                            Cancel
                        </button>
                        <button type="submit"
                            class="flex-1 bg-[#fed700] text-black font-bold py-3 rounded-lg hover:bg-white transition">
                            Submit Request
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <th:block layout:fragment="scripts">
        <script>
            function showCancelModal() {
                document.getElementById('cancelModal').classList.remove('hidden');
                document.getElementById('cancelModal').classList.add('flex');
            }

            function hideCancelModal() {
                document.getElementById('cancelModal').classList.add('hidden');
                document.getElementById('cancelModal').classList.remove('flex');
            }

            function showRefundModal() {
                document.getElementById('refundModal').classList.remove('hidden');
                document.getElementById('refundModal').classList.add('flex');
            }

            function hideRefundModal() {
                document.getElementById('refundModal').classList.add('hidden');
                document.getElementById('refundModal').classList.remove('flex');
            }
        </script>
    </th:block>
</body>

</html>